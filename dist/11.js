(window.webpackJsonp=window.webpackJsonp||[]).push([[11],{39:function(t,e,i){"use strict";i.r(e);var s,r,n=i(20),a=(s=new Date,r=4,{setLogLevel:function(t){r=t==this.debug?1:t==this.info?2:t==this.warn?3:(this.error,4)},debug:function(t,e){1>=r&&console.debug("["+a.getDurationString(new Date-s,1e3)+"]","["+t+"]",e)},info:function(t,e){2>=r&&console.info("["+a.getDurationString(new Date-s,1e3)+"]","["+t+"]",e)},warn:function(t,e){3>=r&&console.warn("["+a.getDurationString(new Date-s,1e3)+"]","["+t+"]",e)},error:function(t,e){4>=r&&console.error("["+a.getDurationString(new Date-s,1e3)+"]","["+t+"]",e)}});
/*! mp4box 12-07-2016 */a.getDurationString=function(t,e){function i(t,e){for(var i=(""+t).split(".");i[0].length<e;)i[0]="0"+i[0];return i.join(".")}var s;0>t?(s=!0,t=-t):s=!1;var r=t/(e||1),n=Math.floor(r/3600);r-=3600*n;var a=Math.floor(r/60),o=1e3*(r-=60*a);return o-=1e3*(r=Math.floor(r)),o=Math.floor(o),(s?"-":"")+n+":"+i(a,2)+":"+i(r,2)+"."+i(o,3)},a.printRanges=function(t){var e=t.length;if(e>0){for(var i="",s=0;e>s;s++)s>0&&(i+=","),i+="["+a.getDurationString(t.start(s))+","+a.getDurationString(t.end(s))+"]";return i}return"(empty)"};var o=function(t){if(!(t instanceof ArrayBuffer))throw"Needs an array buffer";this.buffer=t,this.uint8=new Uint8Array(t),this.position=0};o.prototype.getPosition=function(){return this.position},o.prototype.getEndPosition=function(){return this.buffer.byteLength},o.prototype.getLength=function(){return this.buffer.byteLength},o.prototype.seek=function(t){var e=Math.max(0,Math.min(this.uint8.length,t));this.position=isNaN(e)||!isFinite(e)?0:e},o.prototype.isEos=function(){return this.getPosition()>=this.getEndPosition()},o.prototype.readUint8=function(){var t;if(this.position+1<=this.uint8.length)return t=this.uint8[this.position],this.position++,t;throw"Not enough bytes in buffer"},o.prototype.readUint16=function(){var t,e;if(this.position+2<=this.uint8.length)return t=this.uint8[this.position],this.position++,e=this.uint8[this.position],this.position++,t<<8|e;throw"Not enough bytes in buffer"},o.prototype.readUint24=function(){var t;if(this.position+3<=this.uint8.length)return t=this.uint8[this.position]<<16,this.position++,t|=this.uint8[this.position]<<8,this.position++,t|=this.uint8[this.position],this.position++,t;throw"Not enough bytes in buffer"},o.prototype.readUint32=function(){var t;if(this.position+4<=this.uint8.length)return t=this.uint8[this.position]<<24,this.position++,t|=this.uint8[this.position]<<16,this.position++,t|=this.uint8[this.position]<<8,this.position++,t|=this.uint8[this.position],this.position++,t;throw"Not enough bytes in buffer"},o.prototype.readUint64=function(){if(this.position+8<=this.uint8.length)return this.readUint32()<<32|this.readUint32();throw"Not enough bytes in buffer"},o.prototype.readString=function(t){if(this.position+t<=this.uint8.length){for(var e="",i=0;t>i;i++)e+=String.fromCharCode(this.readUint8());return e}throw"Not enough bytes in buffer"},o.prototype.readCString=function(){for(var t=[];;){var e=this.readUint8();if(0===e)break;t.push(e)}return String.fromCharCode.apply(null,t)},o.prototype.readInt8=function(){return this.readUint8()},o.prototype.readInt16=function(){return this.readUint16()},o.prototype.readInt32=function(){return this.readUint32()},o.prototype.readUint8Array=function(t){for(var e=[],i=0;t>i;i++)e[i]=this.readUint8();return e},o.prototype.readInt16Array=function(t){for(var e=[],i=0;t>i;i++)e[i]=this.readUint16();return e},o.prototype.readUint32Array=function(t){for(var e=[],i=0;t>i;i++)e[i]=this.readUint32();return e},o.prototype.readInt32Array=function(t){for(var e=[],i=0;t>i;i++)e[i]=this.readInt32();return e};var h=function(t,e,i){this._byteOffset=e||0,t instanceof ArrayBuffer?this.buffer=t:"object"==typeof t?(this.dataView=t,e&&(this._byteOffset+=e)):this.buffer=new ArrayBuffer(t||0),this.position=0,this.endianness=null==i?h.LITTLE_ENDIAN:i};h.prototype={},h.prototype.getPosition=function(){return this.position},h.prototype._realloc=function(t){if(this._dynamicSize){var e=this._byteOffset+this.position+t,i=this._buffer.byteLength;if(i>=e)return void(e>this._byteLength&&(this._byteLength=e));for(1>i&&(i=1);e>i;)i*=2;var s=new ArrayBuffer(i),r=new Uint8Array(this._buffer);new Uint8Array(s,0,r.length).set(r),this.buffer=s,this._byteLength=e}},h.prototype._trimAlloc=function(){if(this._byteLength!=this._buffer.byteLength){var t=new ArrayBuffer(this._byteLength),e=new Uint8Array(t),i=new Uint8Array(this._buffer,0,e.length);e.set(i),this.buffer=t}},h.BIG_ENDIAN=!1,h.LITTLE_ENDIAN=!0,h.prototype._byteLength=0,Object.defineProperty(h.prototype,"byteLength",{get:function(){return this._byteLength-this._byteOffset}}),Object.defineProperty(h.prototype,"buffer",{get:function(){return this._trimAlloc(),this._buffer},set:function(t){this._buffer=t,this._dataView=new DataView(this._buffer,this._byteOffset),this._byteLength=this._buffer.byteLength}}),Object.defineProperty(h.prototype,"byteOffset",{get:function(){return this._byteOffset},set:function(t){this._byteOffset=t,this._dataView=new DataView(this._buffer,this._byteOffset),this._byteLength=this._buffer.byteLength}}),Object.defineProperty(h.prototype,"dataView",{get:function(){return this._dataView},set:function(t){this._byteOffset=t.byteOffset,this._buffer=t.buffer,this._dataView=new DataView(this._buffer,this._byteOffset),this._byteLength=this._byteOffset+t.byteLength}}),h.prototype.seek=function(t){var e=Math.max(0,Math.min(this.byteLength,t));this.position=isNaN(e)||!isFinite(e)?0:e},h.prototype.isEof=function(){return this.position>=this._byteLength},h.prototype.mapUint8Array=function(t){this._realloc(1*t);var e=new Uint8Array(this._buffer,this.byteOffset+this.position,t);return this.position+=1*t,e},h.prototype.readInt32Array=function(t,e){t=null==t?this.byteLength-this.position/4:t;var i=new Int32Array(t);return h.memcpy(i.buffer,0,this.buffer,this.byteOffset+this.position,t*i.BYTES_PER_ELEMENT),h.arrayToNative(i,null==e?this.endianness:e),this.position+=i.byteLength,i},h.prototype.readInt16Array=function(t,e){t=null==t?this.byteLength-this.position/2:t;var i=new Int16Array(t);return h.memcpy(i.buffer,0,this.buffer,this.byteOffset+this.position,t*i.BYTES_PER_ELEMENT),h.arrayToNative(i,null==e?this.endianness:e),this.position+=i.byteLength,i},h.prototype.readInt8Array=function(t){t=null==t?this.byteLength-this.position:t;var e=new Int8Array(t);return h.memcpy(e.buffer,0,this.buffer,this.byteOffset+this.position,t*e.BYTES_PER_ELEMENT),this.position+=e.byteLength,e},h.prototype.readUint32Array=function(t,e){t=null==t?this.byteLength-this.position/4:t;var i=new Uint32Array(t);return h.memcpy(i.buffer,0,this.buffer,this.byteOffset+this.position,t*i.BYTES_PER_ELEMENT),h.arrayToNative(i,null==e?this.endianness:e),this.position+=i.byteLength,i},h.prototype.readUint16Array=function(t,e){t=null==t?this.byteLength-this.position/2:t;var i=new Uint16Array(t);return h.memcpy(i.buffer,0,this.buffer,this.byteOffset+this.position,t*i.BYTES_PER_ELEMENT),h.arrayToNative(i,null==e?this.endianness:e),this.position+=i.byteLength,i},h.prototype.readUint8Array=function(t){t=null==t?this.byteLength-this.position:t;var e=new Uint8Array(t);return h.memcpy(e.buffer,0,this.buffer,this.byteOffset+this.position,t*e.BYTES_PER_ELEMENT),this.position+=e.byteLength,e},h.prototype.readFloat64Array=function(t,e){t=null==t?this.byteLength-this.position/8:t;var i=new Float64Array(t);return h.memcpy(i.buffer,0,this.buffer,this.byteOffset+this.position,t*i.BYTES_PER_ELEMENT),h.arrayToNative(i,null==e?this.endianness:e),this.position+=i.byteLength,i},h.prototype.readFloat32Array=function(t,e){t=null==t?this.byteLength-this.position/4:t;var i=new Float32Array(t);return h.memcpy(i.buffer,0,this.buffer,this.byteOffset+this.position,t*i.BYTES_PER_ELEMENT),h.arrayToNative(i,null==e?this.endianness:e),this.position+=i.byteLength,i},h.prototype.readInt32=function(t){var e=this._dataView.getInt32(this.position,null==t?this.endianness:t);return this.position+=4,e},h.prototype.readInt16=function(t){var e=this._dataView.getInt16(this.position,null==t?this.endianness:t);return this.position+=2,e},h.prototype.readInt8=function(){var t=this._dataView.getInt8(this.position);return this.position+=1,t},h.prototype.readUint32=function(t){var e=this._dataView.getUint32(this.position,null==t?this.endianness:t);return this.position+=4,e},h.prototype.readUint16=function(t){var e=this._dataView.getUint16(this.position,null==t?this.endianness:t);return this.position+=2,e},h.prototype.readUint8=function(){var t=this._dataView.getUint8(this.position);return this.position+=1,t},h.prototype.readFloat32=function(t){var e=this._dataView.getFloat32(this.position,null==t?this.endianness:t);return this.position+=4,e},h.prototype.readFloat64=function(t){var e=this._dataView.getFloat64(this.position,null==t?this.endianness:t);return this.position+=8,e},h.endianness=new Int8Array(new Int16Array([1]).buffer)[0]>0,h.memcpy=function(t,e,i,s,r){var n=new Uint8Array(t,e,r),a=new Uint8Array(i,s,r);n.set(a)},h.arrayToNative=function(t,e){return e==this.endianness?t:this.flipArrayEndianness(t)},h.nativeToEndian=function(t,e){return this.endianness==e?t:this.flipArrayEndianness(t)},h.flipArrayEndianness=function(t){for(var e=new Uint8Array(t.buffer,t.byteOffset,t.byteLength),i=0;i<t.byteLength;i+=t.BYTES_PER_ELEMENT)for(var s=i+t.BYTES_PER_ELEMENT-1,r=i;s>r;s--,r++){var n=e[r];e[r]=e[s],e[s]=n}return t},h.prototype.failurePosition=0,String.fromCharCodeUint8=function(t){for(var e=[],i=0;i<t.length;i++)e[i]=t[i];return String.fromCharCode.apply(null,e)},h.prototype.readString=function(t,e){return null==e||"ASCII"==e?String.fromCharCodeUint8.apply(null,[this.mapUint8Array(null==t?this.byteLength-this.position:t)]):new TextDecoder(e).decode(this.mapUint8Array(t))},h.prototype.readCString=function(t){var e=this.byteLength-this.position,i=new Uint8Array(this._buffer,this._byteOffset+this.position),s=e;null!=t&&(s=Math.min(t,e));for(var r=0;s>r&&0!==i[r];r++);var n=String.fromCharCodeUint8.apply(null,[this.mapUint8Array(r)]);return null!=t?this.position+=s-r:r!=e&&(this.position+=1),n};var p=Math.pow(2,32);h.prototype.readUint64=function(){return this.readUint32()*p+this.readUint32()},h.prototype.readUint24=function(){return(this.readUint8()<<16)+(this.readUint8()<<8)+this.readUint8()},"undefined"!=typeof exports&&(exports.DataStream=h),h.prototype.save=function(t){var e=new Blob([this.buffer]),i=window.webkitURL||window.URL;if(!i||!i.createObjectURL)throw"DataStream.save: Can't create object URL.";var s=i.createObjectURL(e),r=document.createElement("a");r.setAttribute("href",s),r.setAttribute("download",t),r.click(),i.revokeObjectURL(s)},h.prototype._dynamicSize=!0,Object.defineProperty(h.prototype,"dynamicSize",{get:function(){return this._dynamicSize},set:function(t){t||this._trimAlloc(),this._dynamicSize=t}}),h.prototype.shift=function(t){var e=new ArrayBuffer(this._byteLength-t),i=new Uint8Array(e),s=new Uint8Array(this._buffer,t,i.length);i.set(s),this.buffer=e,this.position-=t},h.prototype.writeInt32Array=function(t,e){if(this._realloc(4*t.length),t instanceof Int32Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)h.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapInt32Array(t.length,e);else for(var i=0;i<t.length;i++)this.writeInt32(t[i],e)},h.prototype.writeInt16Array=function(t,e){if(this._realloc(2*t.length),t instanceof Int16Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)h.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapInt16Array(t.length,e);else for(var i=0;i<t.length;i++)this.writeInt16(t[i],e)},h.prototype.writeInt8Array=function(t){if(this._realloc(1*t.length),t instanceof Int8Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)h.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapInt8Array(t.length);else for(var e=0;e<t.length;e++)this.writeInt8(t[e])},h.prototype.writeUint32Array=function(t,e){if(this._realloc(4*t.length),t instanceof Uint32Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)h.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapUint32Array(t.length,e);else for(var i=0;i<t.length;i++)this.writeUint32(t[i],e)},h.prototype.writeUint16Array=function(t,e){if(this._realloc(2*t.length),t instanceof Uint16Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)h.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapUint16Array(t.length,e);else for(var i=0;i<t.length;i++)this.writeUint16(t[i],e)},h.prototype.writeUint8Array=function(t){if(this._realloc(1*t.length),t instanceof Uint8Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)h.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapUint8Array(t.length);else for(var e=0;e<t.length;e++)this.writeUint8(t[e])},h.prototype.writeFloat64Array=function(t,e){if(this._realloc(8*t.length),t instanceof Float64Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)h.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapFloat64Array(t.length,e);else for(var i=0;i<t.length;i++)this.writeFloat64(t[i],e)},h.prototype.writeFloat32Array=function(t,e){if(this._realloc(4*t.length),t instanceof Float32Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)h.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapFloat32Array(t.length,e);else for(var i=0;i<t.length;i++)this.writeFloat32(t[i],e)},h.prototype.writeInt32=function(t,e){this._realloc(4),this._dataView.setInt32(this.position,t,null==e?this.endianness:e),this.position+=4},h.prototype.writeInt16=function(t,e){this._realloc(2),this._dataView.setInt16(this.position,t,null==e?this.endianness:e),this.position+=2},h.prototype.writeInt8=function(t){this._realloc(1),this._dataView.setInt8(this.position,t),this.position+=1},h.prototype.writeUint32=function(t,e){this._realloc(4),this._dataView.setUint32(this.position,t,null==e?this.endianness:e),this.position+=4},h.prototype.writeUint16=function(t,e){this._realloc(2),this._dataView.setUint16(this.position,t,null==e?this.endianness:e),this.position+=2},h.prototype.writeUint8=function(t){this._realloc(1),this._dataView.setUint8(this.position,t),this.position+=1},h.prototype.writeFloat32=function(t,e){this._realloc(4),this._dataView.setFloat32(this.position,t,null==e?this.endianness:e),this.position+=4},h.prototype.writeFloat64=function(t,e){this._realloc(8),this._dataView.setFloat64(this.position,t,null==e?this.endianness:e),this.position+=8},h.prototype.writeUCS2String=function(t,e,i){null==i&&(i=t.length);for(var s=0;s<t.length&&i>s;s++)this.writeUint16(t.charCodeAt(s),e);for(;i>s;s++)this.writeUint16(0)},h.prototype.writeString=function(t,e,i){var s=0;if(null==e||"ASCII"==e)if(null!=i){var r=Math.min(t.length,i);for(s=0;r>s;s++)this.writeUint8(t.charCodeAt(s));for(;i>s;s++)this.writeUint8(0)}else for(s=0;s<t.length;s++)this.writeUint8(t.charCodeAt(s));else this.writeUint8Array(new TextEncoder(e).encode(t.substring(0,i)))},h.prototype.writeCString=function(t,e){var i=0;if(null!=e){var s=Math.min(t.length,e);for(i=0;s>i;i++)this.writeUint8(t.charCodeAt(i));for(;e>i;i++)this.writeUint8(0)}else{for(i=0;i<t.length;i++)this.writeUint8(t.charCodeAt(i));this.writeUint8(0)}},h.prototype.writeStruct=function(t,e){for(var i=0;i<t.length;i+=2){var s=t[i+1];this.writeType(s,e[t[i]],e)}},h.prototype.writeType=function(t,e,i){var s;if("function"==typeof t)return t(this,e);if("object"==typeof t&&!(t instanceof Array))return t.set(this,e,i);var r=null,n="ASCII",a=this.position;switch("string"==typeof t&&/:/.test(t)&&(s=t.split(":"),t=s[0],r=parseInt(s[1])),"string"==typeof t&&/,/.test(t)&&(s=t.split(","),t=s[0],n=parseInt(s[1])),t){case"uint8":this.writeUint8(e);break;case"int8":this.writeInt8(e);break;case"uint16":this.writeUint16(e,this.endianness);break;case"int16":this.writeInt16(e,this.endianness);break;case"uint32":this.writeUint32(e,this.endianness);break;case"int32":this.writeInt32(e,this.endianness);break;case"float32":this.writeFloat32(e,this.endianness);break;case"float64":this.writeFloat64(e,this.endianness);break;case"uint16be":this.writeUint16(e,h.BIG_ENDIAN);break;case"int16be":this.writeInt16(e,h.BIG_ENDIAN);break;case"uint32be":this.writeUint32(e,h.BIG_ENDIAN);break;case"int32be":this.writeInt32(e,h.BIG_ENDIAN);break;case"float32be":this.writeFloat32(e,h.BIG_ENDIAN);break;case"float64be":this.writeFloat64(e,h.BIG_ENDIAN);break;case"uint16le":this.writeUint16(e,h.LITTLE_ENDIAN);break;case"int16le":this.writeInt16(e,h.LITTLE_ENDIAN);break;case"uint32le":this.writeUint32(e,h.LITTLE_ENDIAN);break;case"int32le":this.writeInt32(e,h.LITTLE_ENDIAN);break;case"float32le":this.writeFloat32(e,h.LITTLE_ENDIAN);break;case"float64le":this.writeFloat64(e,h.LITTLE_ENDIAN);break;case"cstring":this.writeCString(e,r);break;case"string":this.writeString(e,n,r);break;case"u16string":this.writeUCS2String(e,this.endianness,r);break;case"u16stringle":this.writeUCS2String(e,h.LITTLE_ENDIAN,r);break;case"u16stringbe":this.writeUCS2String(e,h.BIG_ENDIAN,r);break;default:if(3==t.length){for(var o=t[1],p=0;p<e.length;p++)this.writeType(o,e[p]);break}this.writeStruct(t,e)}null!=r&&(this.position=a,this._realloc(r),this.position=a+r)},h.prototype.writeUint64=function(t){var e=Math.floor(t/p);this.writeUint32(e),this.writeUint32(4294967295&t)},h.prototype.writeUint24=function(t){this.writeUint8((16711680&t)>>16),this.writeUint8((65280&t)>>8),this.writeUint8(255&t)},h.prototype.adjustUint32=function(t,e){var i=this.position;this.seek(t),this.writeUint32(e),this.seek(i)},h.prototype.mapInt32Array=function(t,e){this._realloc(4*t);var i=new Int32Array(this._buffer,this.byteOffset+this.position,t);return h.arrayToNative(i,null==e?this.endianness:e),this.position+=4*t,i},h.prototype.mapInt16Array=function(t,e){this._realloc(2*t);var i=new Int16Array(this._buffer,this.byteOffset+this.position,t);return h.arrayToNative(i,null==e?this.endianness:e),this.position+=2*t,i},h.prototype.mapInt8Array=function(t){this._realloc(1*t);var e=new Int8Array(this._buffer,this.byteOffset+this.position,t);return this.position+=1*t,e},h.prototype.mapUint32Array=function(t,e){this._realloc(4*t);var i=new Uint32Array(this._buffer,this.byteOffset+this.position,t);return h.arrayToNative(i,null==e?this.endianness:e),this.position+=4*t,i},h.prototype.mapUint16Array=function(t,e){this._realloc(2*t);var i=new Uint16Array(this._buffer,this.byteOffset+this.position,t);return h.arrayToNative(i,null==e?this.endianness:e),this.position+=2*t,i},h.prototype.mapFloat64Array=function(t,e){this._realloc(8*t);var i=new Float64Array(this._buffer,this.byteOffset+this.position,t);return h.arrayToNative(i,null==e?this.endianness:e),this.position+=8*t,i},h.prototype.mapFloat32Array=function(t,e){this._realloc(4*t);var i=new Float32Array(this._buffer,this.byteOffset+this.position,t);return h.arrayToNative(i,null==e?this.endianness:e),this.position+=4*t,i};var d=function(t){this.buffers=[],this.bufferIndex=-1,t&&(this.insertBuffer(t),this.bufferIndex=0)};(d.prototype=new h(new ArrayBuffer,0,h.BIG_ENDIAN)).initialized=function(){var t;return this.bufferIndex>-1||(this.buffers.length>0?0===(t=this.buffers[0]).fileStart?(this.buffer=t,this.bufferIndex=0,a.debug("MultiBufferStream","Stream ready for parsing"),!0):(a.warn("MultiBufferStream","The first buffer should have a fileStart of 0"),this.logBufferLevel(),!1):(a.warn("MultiBufferStream","No buffer to start parsing from"),this.logBufferLevel(),!1))},ArrayBuffer.concat=function(t,e){a.debug("ArrayBuffer","Trying to create a new buffer of size: "+(t.byteLength+e.byteLength));var i=new Uint8Array(t.byteLength+e.byteLength);return i.set(new Uint8Array(t),0),i.set(new Uint8Array(e),t.byteLength),i.buffer},d.prototype.reduceBuffer=function(t,e,i){var s;return(s=new Uint8Array(i)).set(new Uint8Array(t,e,i)),s.buffer.fileStart=t.fileStart+e,s.buffer.usedBytes=0,s.buffer},d.prototype.insertBuffer=function(t){for(var e=!0,i=0;i<this.buffers.length;i++){var s=this.buffers[i];if(t.fileStart<=s.fileStart){if(t.fileStart===s.fileStart){if(t.byteLength>s.byteLength){this.buffers.splice(i,1),i--;continue}a.warn("MultiBufferStream","Buffer (fileStart: "+t.fileStart+" - Length: "+t.byteLength+") already appended, ignoring")}else t.fileStart+t.byteLength<=s.fileStart||(t=this.reduceBuffer(t,0,s.fileStart-t.fileStart)),a.debug("MultiBufferStream","Appending new buffer (fileStart: "+t.fileStart+" - Length: "+t.byteLength+")"),this.buffers.splice(i,0,t),0===i&&(this.buffer=t);e=!1;break}if(t.fileStart<s.fileStart+s.byteLength){var r=s.fileStart+s.byteLength-t.fileStart,n=t.byteLength-r;if(!(n>0)){e=!1;break}t=this.reduceBuffer(t,r,n)}}e&&(a.debug("MultiBufferStream","Appending new buffer (fileStart: "+t.fileStart+" - Length: "+t.byteLength+")"),this.buffers.push(t),0===i&&(this.buffer=t))},d.prototype.logBufferLevel=function(t){var e,i,s,r,n,o=[],h="";for(s=0,r=0,e=0;e<this.buffers.length;e++)i=this.buffers[e],0===e?(n={},o.push(n),n.start=i.fileStart,n.end=i.fileStart+i.byteLength,h+="["+n.start+"-"):n.end===i.fileStart?n.end=i.fileStart+i.byteLength:((n={}).start=i.fileStart,h+=o[o.length-1].end-1+"], ["+n.start+"-",n.end=i.fileStart+i.byteLength,o.push(n)),s+=i.usedBytes,r+=i.byteLength;o.length>0&&(h+=n.end-1+"]");var p=t?a.info:a.debug;0===this.buffers.length?p("MultiBufferStream","No more buffer in memory"):p("MultiBufferStream",this.buffers.length+" stored buffer(s) ("+s+"/"+r+" bytes): "+h)},d.prototype.cleanBuffers=function(){var t,e;for(t=0;t<this.buffers.length;t++)(e=this.buffers[t]).usedBytes===e.byteLength&&(a.debug("MultiBufferStream","Removing buffer #"+t),this.buffers.splice(t,1),t--)},d.prototype.mergeNextBuffer=function(){var t;if(this.bufferIndex+1<this.buffers.length){if((t=this.buffers[this.bufferIndex+1]).fileStart===this.buffer.fileStart+this.buffer.byteLength){var e=this.buffer.byteLength,i=this.buffer.usedBytes,s=this.buffer.fileStart;return this.buffers[this.bufferIndex]=ArrayBuffer.concat(this.buffer,t),this.buffer=this.buffers[this.bufferIndex],this.buffers.splice(this.bufferIndex+1,1),this.buffer.usedBytes=i,this.buffer.fileStart=s,a.debug("ISOFile","Concatenating buffer for box parsing (length: "+e+"->"+this.buffer.byteLength+")"),!0}return!1}return!1},d.prototype.findPosition=function(t,e,i){var s,r=null,n=-1;for(s=!0===t?0:this.bufferIndex;s<this.buffers.length&&(r=this.buffers[s]).fileStart<=e;)n=s,i&&(r.fileStart+r.byteLength<=e?r.usedBytes=r.byteLength:r.usedBytes=e-r.fileStart,this.logBufferLevel()),s++;return-1!==n?(r=this.buffers[n]).fileStart+r.byteLength>=e?(a.debug("MultiBufferStream","Found position in existing buffer #"+n),n):-1:-1},d.prototype.findEndContiguousBuf=function(t){var e,i,s,r=void 0!==t?t:this.bufferIndex;if(i=this.buffers[r],this.buffers.length>r+1)for(e=r+1;e<this.buffers.length&&(s=this.buffers[e]).fileStart===i.fileStart+i.byteLength;e++)i=s;return i.fileStart+i.byteLength},d.prototype.getEndFilePositionAfter=function(t){var e=this.findPosition(!0,t,!1);return-1!==e?this.findEndContiguousBuf(e):t},d.prototype.addUsedBytes=function(t){this.buffer.usedBytes+=t,this.logBufferLevel()},d.prototype.setAllUsedBytes=function(){this.buffer.usedBytes=this.buffer.byteLength,this.logBufferLevel()},d.prototype.seek=function(t,e,i){var s;return-1!==(s=this.findPosition(e,t,i))?(this.buffer=this.buffers[s],this.bufferIndex=s,this.position=t-this.buffer.fileStart,a.debug("MultiBufferStream","Repositioning parser at buffer position: "+this.position),!0):(a.debug("MultiBufferStream","Position "+t+" not found in buffered data"),!1)},d.prototype.getPosition=function(){if(-1===this.bufferIndex||null===this.buffers[this.bufferIndex])throw"Error accessing position in the MultiBufferStream";return this.buffers[this.bufferIndex].fileStart+this.position},d.prototype.getLength=function(){return this.byteLength},d.prototype.getEndPosition=function(){if(-1===this.bufferIndex||null===this.buffers[this.bufferIndex])throw"Error accessing position in the MultiBufferStream";return this.buffers[this.bufferIndex].fileStart+this.byteLength};var f=function(){var t=[];t[3]="ES_Descriptor",t[4]="DecoderConfigDescriptor",t[5]="DecoderSpecificInfo",t[6]="SLConfigDescriptor";var e=this,i={};return this.parseOneDescriptor=function(e){var s,r,n,o=0;for(s=e.readUint8(),n=e.readUint8();128&n;)o=(127&n)<<7,n=e.readUint8();return o+=127&n,a.debug("MPEG4DescriptorParser","Found "+(t[s]||"Descriptor "+s)+", size "+o+" at position "+e.getPosition()),(r=t[s]?new i[t[s]](o):new i.Descriptor(o)).parse(e),r},i.Descriptor=function(t,e){this.tag=t,this.size=e,this.descs=[]},i.Descriptor.prototype.parse=function(t){this.data=t.readUint8Array(this.size)},i.Descriptor.prototype.findDescriptor=function(t){for(var e=0;e<this.descs.length;e++)if(this.descs[e].tag==t)return this.descs[e];return null},i.Descriptor.prototype.parseRemainingDescriptors=function(t){for(var i=t.position;t.position<i+this.size;){var s=e.parseOneDescriptor(t);this.descs.push(s)}},i.ES_Descriptor=function(t){i.Descriptor.call(this,3,t)},i.ES_Descriptor.prototype=new i.Descriptor,i.ES_Descriptor.prototype.parse=function(t){if(this.ES_ID=t.readUint16(),this.flags=t.readUint8(),this.size-=3,128&this.flags?(this.dependsOn_ES_ID=t.readUint16(),this.size-=2):this.dependsOn_ES_ID=0,64&this.flags){var e=t.readUint8();this.URL=t.readString(e),this.size-=e+1}else this.URL=null;32&this.flags?(this.OCR_ES_ID=t.readUint16(),this.size-=2):this.OCR_ES_ID=0,this.parseRemainingDescriptors(t)},i.ES_Descriptor.prototype.getOTI=function(t){var e=this.findDescriptor(4);return e?e.oti:0},i.ES_Descriptor.prototype.getAudioConfig=function(t){var e=this.findDescriptor(4);if(!e)return null;var i=e.findDescriptor(5);return i&&i.data?(248&i.data[0])>>3:null},i.DecoderConfigDescriptor=function(t){i.Descriptor.call(this,4,t)},i.DecoderConfigDescriptor.prototype=new i.Descriptor,i.DecoderConfigDescriptor.prototype.parse=function(t){this.oti=t.readUint8(),this.streamType=t.readUint8(),this.bufferSize=t.readUint24(),this.maxBitrate=t.readUint32(),this.avgBitrate=t.readUint32(),this.size-=13,this.parseRemainingDescriptors(t)},i.DecoderSpecificInfo=function(t){i.Descriptor.call(this,5,t)},i.DecoderSpecificInfo.prototype=new i.Descriptor,i.SLConfigDescriptor=function(t){i.Descriptor.call(this,6,t)},i.SLConfigDescriptor.prototype=new i.Descriptor,this},l={ERR_INVALID_DATA:-1,ERR_NOT_ENOUGH_DATA:0,OK:1,boxCodes:["mdat","idat","free","skip","avcC","hvcC","ftyp","styp","payl","vttC","rtp ","sdp ","btrt","frma","trpy","tpyl","totl","tpay","dmed","dimm","drep","nump","npck","maxr","tmin","tmax","dmax","pmax","payt","vmhd","smhd","hmhd","idat","meco","udta","strk","free","skip"],fullBoxCodes:["mvhd","tkhd","mdhd","hdlr","vmhd","smhd","hmhd","nmhd","url ","urn ","ctts","cslg","stco","co64","stsc","stss","stsz","stz2","stts","stsh","mehd","trex","mfhd","tfhd","trun","tfdt","esds","subs","txtC","sidx","emsg","prft","pssh","elst","dref","url ","urn ","sbgp","sgpd","cprt","iods","ssix","tfra","mfro","pdin","tsel","trep","leva","stri","stsg","schm","stvi","padb","stdp","sdtp","saio","saiz","meta","xml ","bxml","iloc","pitm","ipro","iinf","infe","iref","mere","kind","elng"],containerBoxCodes:[["moov",["trak","sidx"]],["trak"],["edts"],["mdia"],["minf"],["dinf"],["stbl",["sgpd","sbgp"]],["mvex",["trex"]],["moof",["traf"]],["traf",["trun","sgpd","sbgp"]],["vttc"],["tref"],["iref"],["udta"],["mfra"],["meco"],["hnti"],["hinf"],["strk"],["strd"],["sinf"],["rinf"],["schi"],["trgr"],["udta",["kind"]],["iprp"]],sampleEntryCodes:[{prefix:"Visual",types:["mp4v","avc1","avc2","avc3","avc4","avcp","drac","encv","mjp2","mvc1","mvc2","resv","s263","svc1","vc-1","hvc1","hev1"]},{prefix:"Audio",types:["mp4a","ac-3","alac","dra1","dtsc","dtse",,"dtsh","dtsl","ec-3","enca","g719","g726","m4ae","mlpa","raw ","samr","sawb","sawp","sevc","sqcp","ssmv","twos",".mp3"]},{prefix:"Hint",types:["fdp ","m2ts","pm2t","prtp","rm2t","rrtp","rsrp","rtp ","sm2t","srtp"]},{prefix:"Metadata",types:["metx","mett","urim"]},{prefix:"Subtitle",types:["stpp","wvtt","sbtt","tx3g","stxt"]},{prefix:"System",types:["mp4s"]}],sampleGroupEntryCodes:["roll","prol","alst","rap ","tele","avss","avll","sync","tscl","tsas","stsa","scif","mvif","scnm","dtrt","vipr","tele","rash"],trackGroupTypes:["msrc"],initialize:function(){var t,e,i;for(l.FullBox.prototype=new l.Box,l.ContainerBox.prototype=new l.Box,l.SampleEntry.prototype=new l.FullBox,l.TrackGroupTypeBox.prototype=new l.FullBox,i=l.boxCodes.length,t=0;i>t;t++)l[l.boxCodes[t]+"Box"]=function(t){return function(e){l.Box.call(this,l.boxCodes[t],e)}}(t),l[l.boxCodes[t]+"Box"].prototype=new l.Box;for(i=l.fullBoxCodes.length,t=0;i>t;t++)l[l.fullBoxCodes[t]+"Box"]=function(t){return function(e){l.FullBox.call(this,l.fullBoxCodes[t],e)}}(t),l[l.fullBoxCodes[t]+"Box"].prototype=new l.FullBox;for(i=l.containerBoxCodes.length,t=0;i>t;t++)l[l.containerBoxCodes[t][0]+"Box"]=function(t,e){return function(i){if(l.ContainerBox.call(this,l.containerBoxCodes[t][0],i),e){this.subBoxNames=e;for(var s=e.length,r=0;s>r;r++)this[e[r]+"s"]=[]}}}(t,l.containerBoxCodes[t][1]),l[l.containerBoxCodes[t][0]+"Box"].prototype=new l.ContainerBox;for(i=l.sampleEntryCodes.length,e=0;i>e;e++){var s=l.sampleEntryCodes[e].prefix,r=l.sampleEntryCodes[e].types,n=r.length;for(l[s+"SampleEntry"]=function(t,e){l.SampleEntry.call(this,t,e)},l[s+"SampleEntry"].prototype=new l.SampleEntry,t=0;n>t;t++)l[r[t]+"SampleEntry"]=function(t,e){return function(i){l[l.sampleEntryCodes[t].prefix+"SampleEntry"].call(this,l.sampleEntryCodes[t].types[e],i)}}(e,t),l[r[t]+"SampleEntry"].prototype=new l[s+"SampleEntry"]}for(i=l.sampleGroupEntryCodes.length,t=0;i>t;t++)l[l.sampleGroupEntryCodes[t]+"SampleGroupEntry"]=function(t){return function(e){l.SampleGroupEntry.call(this,l.sampleGroupEntryCodes[t],e)}}(t),l[l.sampleGroupEntryCodes[t]+"SampleGroupEntry"].prototype=new l.SampleGroupEntry;for(i=l.trackGroupTypes.length,t=0;i>t;t++)l[l.trackGroupTypes[t]+"Box"]=function(t){return function(e){l.TrackGroupTypeBox.call(this,l.trackGroupTypes[t],e)}}(t),l[l.trackGroupTypes[t]+"Box"].prototype=new l.TrackGroupTypeBox},Box:function(t,e){this.type=t,this.size=e},FullBox:function(t,e){l.Box.call(this,t,e),this.flags=0,this.version=0},ContainerBox:function(t,e){l.Box.call(this,t,e),this.boxes=[]},SampleEntry:function(t,e,i,s){l.Box.call(this,t,e),this.hdr_size=i,this.start=s,this.boxes=[]},SampleGroupEntry:function(t){this.grouping_type=t},TrackGroupTypeBox:function(t,e){l.FullBox.call(this,t,e)}};l.initialize(),l.TKHD_FLAG_ENABLED=1,l.TKHD_FLAG_IN_MOVIE=2,l.TKHD_FLAG_IN_PREVIEW=4,l.TFHD_FLAG_BASE_DATA_OFFSET=1,l.TFHD_FLAG_SAMPLE_DESC=2,l.TFHD_FLAG_SAMPLE_DUR=8,l.TFHD_FLAG_SAMPLE_SIZE=16,l.TFHD_FLAG_SAMPLE_FLAGS=32,l.TFHD_FLAG_DUR_EMPTY=65536,l.TFHD_FLAG_DEFAULT_BASE_IS_MOOF=131072,l.TRUN_FLAGS_DATA_OFFSET=1,l.TRUN_FLAGS_FIRST_FLAG=4,l.TRUN_FLAGS_DURATION=256,l.TRUN_FLAGS_SIZE=512,l.TRUN_FLAGS_FLAGS=1024,l.TRUN_FLAGS_CTS_OFFSET=2048,l.Box.prototype.add=function(t){var e=new l[t+"Box"];return this.boxes.push(e),this[t+"s"]?this[t+"s"].push(e):this[t]=e,e},l.Box.prototype.set=function(t,e){return this[t]=e,this},l.Box.prototype.addEntry=function(t,e){var i=e||"entries";return this[i]||(this[i]=[]),this[i].push(t),this},"undefined"!=typeof exports&&(exports.BoxParser=l),l.SampleEntry.prototype.isVideo=function(){return!1},l.SampleEntry.prototype.isAudio=function(){return!1},l.SampleEntry.prototype.isSubtitle=function(){return!1},l.SampleEntry.prototype.isMetadata=function(){return!1},l.SampleEntry.prototype.isHint=function(){return!1},l.SampleEntry.prototype.getCodec=function(){return this.type.replace(".","")},l.SampleEntry.prototype.getWidth=function(){return""},l.SampleEntry.prototype.getHeight=function(){return""},l.SampleEntry.prototype.getChannelCount=function(){return""},l.SampleEntry.prototype.getSampleRate=function(){return""},l.SampleEntry.prototype.getSampleSize=function(){return""},l.VisualSampleEntry.prototype.isVideo=function(){return!0},l.VisualSampleEntry.prototype.getWidth=function(){return this.width},l.VisualSampleEntry.prototype.getHeight=function(){return this.height},l.AudioSampleEntry.prototype.isAudio=function(){return!0},l.AudioSampleEntry.prototype.getChannelCount=function(){return this.channel_count},l.AudioSampleEntry.prototype.getSampleRate=function(){return this.samplerate},l.AudioSampleEntry.prototype.getSampleSize=function(){return this.samplesize},l.SubtitleSampleEntry.prototype.isSubtitle=function(){return!0},l.MetadataSampleEntry.prototype.isMetadata=function(){return!0},l.decimalToHex=function(t,e){var i=Number(t).toString(16);for(e=null==e?e=2:e;i.length<e;)i="0"+i;return i},l.avc1SampleEntry.prototype.getCodec=function(){var t=l.SampleEntry.prototype.getCodec.call(this);return this.avcC?t+"."+l.decimalToHex(this.avcC.AVCProfileIndication)+l.decimalToHex(this.avcC.profile_compatibility)+l.decimalToHex(this.avcC.AVCLevelIndication):t},l.hvc1SampleEntry.prototype.getCodec=function(){var t,e=l.SampleEntry.prototype.getCodec.call(this);if(this.hvcC){switch(e+=".",this.hvcC.general_profile_space){case 0:e+="";break;case 1:e+="A";break;case 2:e+="B";break;case 3:e+="C"}e+=this.hvcC.general_profile_idc,e+=".";var i=this.hvcC.general_profile_compatibility,s=0;for(t=0;32>t&&(s|=1&i,31!=t);t++)s<<=1,i>>=1;e+=l.decimalToHex(s,0),e+=".",e+=0===this.hvcC.general_tier_flag?"L":"H",e+=this.hvcC.general_level_idc;var r=!1,n="";for(t=5;t>=0;t--)(this.hvcC.general_constraint_indicator[t]||r)&&(n="."+l.decimalToHex(this.hvcC.general_constraint_indicator[t],0)+n,r=!0);e+=n}return e},l.mp4aSampleEntry.prototype.getCodec=function(){var t=l.SampleEntry.prototype.getCodec.call(this);if(this.esds&&this.esds.esd){var e=this.esds.esd.getOTI(),i=this.esds.esd.getAudioConfig();return t+"."+l.decimalToHex(e)+(i?"."+i:"")}return t},l.stxtSampleEntry.prototype.getCodec=function(){var t=l.SampleEntry.prototype.getCodec.call(this);return this.mime_format?t+"."+this.mime_format:t},l.parseOneBox=function(t,e,i){var s,r,n,o=t.getPosition(),h=0;if(t.getEndPosition()-o<8)return a.debug("BoxParser","Not enough data in stream to parse the type and size of the box"),{code:l.ERR_NOT_ENOUGH_DATA};var p=t.readUint32(),d=t.readString(4);if(a.debug("BoxParser","Found box of type "+d+" and size "+p+" at position "+o),h=8,"uuid"==d&&(n=t.readUint8Array(16),h+=16),1==p){if(t.getEndPosition()-t.getPosition()<8)return t.seek(o),a.warn("BoxParser",'Not enough data in stream to parse the extended size of the "'+d+'" box'),{code:l.ERR_NOT_ENOUGH_DATA};p=t.readUint64(),h+=8}else if(0===p&&"mdat"!==d)throw"Unlimited box size not supported";return i&&p>i?(a.error("BoxParser","Box of type "+d+" has a size "+p+" greater than its container size "+i),{code:l.ERR_NOT_ENOUGH_DATA,type:d,size:p,hdr_size:h,start:o}):o+p>t.getEndPosition()?(t.seek(o),a.warn("BoxParser",'Not enough data in stream to parse the entire "'+d+'" box'),{code:l.ERR_NOT_ENOUGH_DATA,type:d,size:p,hdr_size:h,start:o}):e?{code:l.OK,type:d,size:p,hdr_size:h,start:o}:(l[d+"Box"]?s=new l[d+"Box"](p):("uuid"!==d&&a.warn("BoxParser","Unknown box type: "+d),s=new l.Box(d,p),n&&(s.uuid=n)),s.hdr_size=h,s.start=o,s.write===l.Box.prototype.write&&"mdat"!==s.type&&(a.warn("BoxParser",s.type+" box writing not yet implemented, keeping unparsed data in memory for later write"),s.parseDataAndRewind(t)),s.parse(t),0>(r=t.getPosition()-(s.start+s.size))?(a.warn("BoxParser","Parsing of box "+s.type+" did not read the entire indicated box data size (missing "+-r+" bytes), seeking forward"),t.seek(s.start+s.size)):r>0&&(a.error("BoxParser","Parsing of box "+s.type+" read "+r+" more bytes than the indicated box data size, seeking backwards"),t.seek(s.start+s.size)),{code:l.OK,box:s,size:s.size})},l.Box.prototype.parse=function(t){"mdat"!=this.type?this.data=t.readUint8Array(this.size-this.hdr_size):0===this.size?t.seek(t.getEndPosition()):t.seek(this.start+this.size)},l.Box.prototype.parseDataAndRewind=function(t){this.data=t.readUint8Array(this.size-this.hdr_size),t.position-=this.size-this.hdr_size},l.FullBox.prototype.parseDataAndRewind=function(t){this.parseFullHeader(t),this.data=t.readUint8Array(this.size-this.hdr_size),this.hdr_size-=4,t.position-=this.size-this.hdr_size},l.FullBox.prototype.parseFullHeader=function(t){this.version=t.readUint8(),this.flags=t.readUint24(),this.hdr_size+=4},l.FullBox.prototype.parse=function(t){this.parseFullHeader(t),this.data=t.readUint8Array(this.size-this.hdr_size)},l.ContainerBox.prototype.parse=function(t){for(var e,i;t.getPosition()<this.start+this.size;){if((e=l.parseOneBox(t,!1,this.size-(t.getPosition()-this.start))).code!==l.OK)return;i=e.box,this.boxes.push(i),this.subBoxNames&&-1!=this.subBoxNames.indexOf(i.type)?this[this.subBoxNames[this.subBoxNames.indexOf(i.type)]+"s"].push(i):this[i.type]=i}},l.Box.prototype.parseLanguage=function(t){this.language=t.readUint16();var e=[];e[0]=this.language>>10&31,e[1]=this.language>>5&31,e[2]=31&this.language,this.languageString=String.fromCharCode(e[0]+96,e[1]+96,e[2]+96)},l.TrackGroupTypeBox.prototype.parse=function(t){this.parseFullHeader(t),this.track_group_id=t.readUint32()},l.TrackReferenceTypeBox=function(t,e,i,s){l.Box.call(this,t,e),this.hdr_size=i,this.start=s},l.TrackReferenceTypeBox.prototype=new l.Box,l.TrackReferenceTypeBox.prototype.parse=function(t){this.track_ids=t.readUint32Array((this.size-this.hdr_size)/4)},l.avcCBox.prototype.parse=function(t){var e,i,s,r;for(this.configurationVersion=t.readUint8(),this.AVCProfileIndication=t.readUint8(),this.profile_compatibility=t.readUint8(),this.AVCLevelIndication=t.readUint8(),this.lengthSizeMinusOne=3&t.readUint8(),i=31&t.readUint8(),r=this.size-this.hdr_size-6,this.SPS=new Array(i),e=0;i>e;e++)s=t.readUint16(),this.SPS[e]=t.readUint8Array(s),r-=2+s;for(i=t.readUint8(),r--,this.PPS=new Array(i),e=0;i>e;e++)s=t.readUint16(),this.PPS[e]=t.readUint8Array(s),r-=2+s;r>0&&(this.ext=t.readUint8Array(r))},l.btrtBox.prototype.parse=function(t){this.bufferSizeDB=t.readUint32(),this.maxBitrate=t.readUint32(),this.avgBitrate=t.readUint32()},l.co64Box.prototype.parse=function(t){var e,i;if(this.parseFullHeader(t),e=t.readUint32(),this.chunk_offsets=[],0===this.version)for(i=0;e>i;i++)this.chunk_offsets.push(t.readUint64())},l.cprtBox.prototype.parse=function(t){this.parseFullHeader(t),this.parseLanguage(t),this.notice=t.readCString()},l.cslgBox.prototype.parse=function(t){this.parseFullHeader(t),0===this.version&&(this.compositionToDTSShift=t.readInt32(),this.leastDecodeToDisplayDelta=t.readInt32(),this.greatestDecodeToDisplayDelta=t.readInt32(),this.compositionStartTime=t.readInt32(),this.compositionEndTime=t.readInt32())},l.cttsBox.prototype.parse=function(t){var e,i;if(this.parseFullHeader(t),e=t.readUint32(),this.sample_counts=[],this.sample_offsets=[],0===this.version)for(i=0;e>i;i++)this.sample_counts.push(t.readUint32()),this.sample_offsets.push(t.readInt32());else if(1==this.version)for(i=0;e>i;i++)this.sample_counts.push(t.readUint32()),this.sample_offsets.push(t.readInt32())},l.dimmBox.prototype.parse=function(t){this.bytessent=t.readUint64()},l.dmaxBox.prototype.parse=function(t){this.time=t.readUint32()},l.dmedBox.prototype.parse=function(t){this.bytessent=t.readUint64()},l.drefBox.prototype.parse=function(t){var e,i;this.parseFullHeader(t),this.entries=[];for(var s=t.readUint32(),r=0;s>r;r++){if((e=l.parseOneBox(t,!1,this.size-(t.getPosition()-this.start))).code!==l.OK)return;i=e.box,this.entries.push(i)}},l.drepBox.prototype.parse=function(t){this.bytessent=t.readUint64()},l.elngBox.prototype.parse=function(t){this.parseFullHeader(t),this.extended_language=t.readString(this.size-this.hdr_size)},l.elstBox.prototype.parse=function(t){this.parseFullHeader(t),this.entries=[];for(var e=t.readUint32(),i=0;e>i;i++){var s={};this.entries.push(s),1===this.version?(s.segment_duration=t.readUint64(),s.media_time=t.readInt64()):(s.segment_duration=t.readUint32(),s.media_time=t.readInt32()),s.media_rate_integer=t.readInt16(),s.media_rate_fraction=t.readInt16()}},l.emsgBox.prototype.parse=function(t){this.parseFullHeader(t),this.scheme_id_uri=t.readCString(),this.value=t.readCString(),this.timescale=t.readUint32(),this.presentation_time_delta=t.readUint32(),this.event_duration=t.readUint32(),this.id=t.readUint32();var e=this.size-this.hdr_size-(16+(this.scheme_id_uri.length+1)+(this.value.length+1));this.message_data=t.readUint8Array(e)},l.esdsBox.prototype.parse=function(t){this.parseFullHeader(t);var e=t.readUint8Array(this.size-this.hdr_size),i=new f;this.esd=i.parseOneDescriptor(new h(e.buffer,0,h.BIG_ENDIAN))},l.frmaBox.prototype.parse=function(t){this.data_format=t.readString(4)},l.ftypBox.prototype.parse=function(t){var e=this.size-this.hdr_size;this.major_brand=t.readString(4),this.minor_version=t.readUint32(),e-=8,this.compatible_brands=[];for(var i=0;e>=4;)this.compatible_brands[i]=t.readString(4),e-=4,i++},l.hdlrBox.prototype.parse=function(t){this.parseFullHeader(t),0===this.version&&(t.readUint32(),this.handler=t.readString(4),t.readUint32Array(3),this.name=t.readString(this.size-this.hdr_size-20),"\0"===this.name[this.name.length-1]&&(this.name=this.name.slice(0,-1)))},l.hvcCBox.prototype.parse=function(t){var e,i,s,r;this.configurationVersion=t.readUint8(),r=t.readUint8(),this.general_profile_space=r>>6,this.general_tier_flag=(32&r)>>5,this.general_profile_idc=31&r,this.general_profile_compatibility=t.readUint32(),this.general_constraint_indicator=t.readUint8Array(6),this.general_level_idc=t.readUint8(),this.min_spatial_segmentation_idc=4095&t.readUint16(),this.parallelismType=3&t.readUint8(),this.chromaFormat=3&t.readUint8(),this.bitDepthLumaMinus8=7&t.readUint8(),this.bitDepthChromaMinus8=7&t.readUint8(),this.avgFrameRate=t.readUint16(),r=t.readUint8(),this.constantFrameRate=r>>6,this.numTemporalLayers=(13&r)>>3,this.temporalIdNested=(4&r)>>2,this.lengthSizeMinusOne=3&r,this.nalu_arrays=[];var n=t.readUint8();for(e=0;n>e;e++){var a=[];this.nalu_arrays.push(a),r=t.readUint8(),a.completeness=(128&r)>>7,a.nalu_type=63&r;var o=t.readUint16();for(i=0;o>i;i++){var h={};a.push(h),s=t.readUint16(),h.data=t.readUint8Array(s)}}},l.iinfBox.prototype.parse=function(t){var e;this.parseFullHeader(t),0===this.version?this.entry_count=t.readUint16():this.entry_count=t.readUint32(),this.item_infos=[];for(var i=0;i<this.entry_count;i++){if((e=l.parseOneBox(t,!1,this.size-(t.getPosition()-this.start))).code!==l.OK)return;"infe"!==e.box.type&&a.error("BoxParser","Expected 'infe' box, got "+e.box.type),this.item_infos[i]=e.box}},l.ilocBox.prototype.parse=function(t){var e;this.parseFullHeader(t),e=t.readUint8(),this.offset_size=e>>4&15,this.length_size=15&e,e=t.readUint8(),this.base_offset_size=e>>4&15,1===this.version||2===this.version?this.index_size=15&e:this.index_size=0,this.items=[];var i=0;if(this.version<2)i=t.readUint16();else{if(2!==this.version)throw"version of iloc box not supported";i=t.readUint32()}for(var s=0;i>s;s++){var r={};if(this.items.push(r),this.version<2)r.item_ID=t.readUint16();else{if(2!==this.version)throw"version of iloc box not supported";r.item_ID=t.readUint16()}switch(1!==this.version&&2!==this.version||(r.construction_method=15&t.readUint16()),r.data_reference_index=t.readUint16(),this.base_offset_size){case 0:r.base_offset=0;break;case 4:r.base_offset=t.readUint32();break;case 8:r.base_offset=t.readUint64();break;default:throw"Error reading base offset size"}var n=t.readUint16();r.extents=[];for(var a=0;n>a;a++){var o={};if(r.extents.push(o),1===this.version||2===this.version)switch(this.index_size){case 0:o.extent_index=0;break;case 4:o.extent_index=t.readUint32();break;case 8:o.extent_index=t.readUint64();break;default:throw"Error reading extent index"}switch(this.offset_size){case 0:o.extent_offset=0;break;case 4:o.extent_offset=t.readUint32();break;case 8:o.extent_offset=t.readUint64();break;default:throw"Error reading extent index"}switch(this.length_size){case 0:o.extent_length=0;break;case 4:o.extent_length=t.readUint32();break;case 8:o.extent_length=t.readUint64();break;default:throw"Error reading extent index"}}}},l.infeBox.prototype.parse=function(t){return this.parseFullHeader(t),0!==this.version&&1!==this.version||(this.item_ID=t.readUint16(),this.item_protection_index=t.readUint16(),this.item_name=t.readCString(),this.content_type=t.readCString(),this.content_encoding=t.readCString()),1===this.version?(this.extension_type=t.readString(4),a.warn("BoxParser","Cannot parse extension type"),void t.seek(this.start+this.size)):void(this.version>=2&&(2===this.version?this.item_ID=t.readUint16():3===this.version&&(this.item_ID=t.readUint32()),this.item_protection_index=t.readUint16(),this.item_type=t.readString(4),this.name=t.readCString(),"mime"===this.item_type?(this.content_type=t.readCString(),this.content_encoding=t.readCString()):"uri "===this.item_type&&(this.item_uri_type=t.readCString())))},l.irefBox=function(t){l.FullBox.call(this,"iref",t),this.references=[]},l.irefBox.prototype=new l.FullBox,l.irefBox.prototype.parse=function(t){var e,i;for(this.parseFullHeader(t);t.getPosition()<this.start+this.size;){if((e=l.parseOneBox(t,!0,this.size-(t.getPosition()-this.start))).code!==l.OK)return;(i=0===this.version?new l.SingleItemTypeReferenceBox(e.type,e.size,e.hdr_size,e.start):new l.SingleItemTypeReferenceBoxLarge(e.type,e.size,e.hdr_size,e.start)).write===l.Box.prototype.write&&"mdat"!==i.type&&(a.warn("BoxParser",i.type+" box writing not yet implemented, keeping unparsed data in memory for later write"),i.parseDataAndRewind(t)),i.parse(t),this.references.push(i)}},l.kindBox=function(t){l.FullBox.call(this,"kind",t),this.schemeURI="",this.value=""},l.kindBox.prototype=new l.FullBox,l.kindBox.prototype.parse=function(t){this.parseFullHeader(t),this.schemeURI=t.readCString(),this.value=t.readCString()},l.levaBox.prototype.parse=function(t){this.parseFullHeader(t);var e=t.readUint8();this.levels=[];for(var i=0;e>i;i++){var s={};this.levels[i]=s,s.track_ID=t.readUint32();var r=t.readUint8();switch(s.padding_flag=r>>7,s.assignment_type=127&r,s.assignment_type){case 0:s.grouping_type=t.readUint32();break;case 1:s.grouping_type=t.readUint32(),s.grouping_type_parameter=t.readUint32();break;case 2:case 3:break;case 4:s.sub_track_id=t.readUint32();break;default:a.warn("BoxParser","Unknown leva assignement type")}}},l.maxrBox.prototype.parse=function(t){this.period=t.readUint32(),this.bytes=t.readUint32()},l.mdhdBox.prototype.parse=function(t){this.parseFullHeader(t),1==this.version?(this.creation_time=t.readUint64(),this.modification_time=t.readUint64(),this.timescale=t.readUint32(),this.duration=t.readUint64()):(this.creation_time=t.readUint32(),this.modification_time=t.readUint32(),this.timescale=t.readUint32(),this.duration=t.readUint32()),this.parseLanguage(t),t.readUint16()},l.mehdBox.prototype.parse=function(t){this.parseFullHeader(t),1|this.flags&&(a.warn("BoxParser","mehd box incorrectly uses flags set to 1, converting version to 1"),this.version=1),1==this.version?this.fragment_duration=t.readUint64():this.fragment_duration=t.readUint32()},l.metaBox.prototype.parse=function(t){this.parseFullHeader(t),this.boxes=[],l.ContainerBox.prototype.parse.call(this,t)},l.mfhdBox.prototype.parse=function(t){this.parseFullHeader(t),this.sequence_number=t.readUint32()},l.mfroBox.prototype.parse=function(t){this.parseFullHeader(t),this._size=t.readUint32()},l.mvhdBox.prototype.parse=function(t){this.flags=0,this.parseFullHeader(t),1==this.version?(this.creation_time=t.readUint64(),this.modification_time=t.readUint64(),this.timescale=t.readUint32(),this.duration=t.readUint64()):(this.creation_time=t.readUint32(),this.modification_time=t.readUint32(),this.timescale=t.readUint32(),this.duration=t.readUint32()),this.rate=t.readUint32(),this.volume=t.readUint16()>>8,t.readUint16(),t.readUint32Array(2),this.matrix=t.readUint32Array(9),t.readUint32Array(6),this.next_track_id=t.readUint32()},l.npckBox.prototype.parse=function(t){this.packetssent=t.readUint32()},l.numpBox.prototype.parse=function(t){this.packetssent=t.readUint64()},l.padbBox.prototype.parse=function(t){this.parseFullHeader(t);var e=t.readUint32();this.padbits=[];for(var i=0;i<Math.floor((e+1)/2);i++)this.padbits=t.readUint8()},l.paylBox.prototype.parse=function(t){this.text=t.readString(this.size-this.hdr_size)},l.paytBox.prototype.parse=function(t){this.payloadID=t.readUint32();var e=t.readUint8();this.rtpmap_string=t.readString(e)},l.pdinBox.prototype.parse=function(t){this.parseFullHeader(t);var e=(this.size-this.hdr_size)/8;this.rate=[],this.initial_delay=[];for(var i=0;e>i;i++)this.rate[i]=t.readUint32(),this.initial_delay[i]=t.readUint32()},l.pitmBox.prototype.parse=function(t){this.parseFullHeader(t),0===this.version?this.item_id=t.readUint16():this.item_id=t.readUint32()},l.pmaxBox.prototype.parse=function(t){this.bytes=t.readUint32()},l.prftBox.prototype.parse=function(t){this.parseFullHeader(t),this.ref_track_id=t.readUint32(),this.ntp_timestamp=t.readUint64(),0===this.version?this.media_time=t.readUint32():this.media_time=t.readUint64()},l.psshBox.prototype.parse=function(t){if(this.parseFullHeader(t),this.system_id=t.readUint8Array(16),this.version>0){var e=t.readUint32();this.kid=[];for(var i=0;e>i;i++)this.kid[i]=t.readUint8Array(16)}var s=t.readUint32();s>0&&(this.data=t.readUint8Array(s))},l["rtp Box"].prototype.parse=function(t){this.descriptionformat=t.readString(4),this.sdptext=t.readString(this.size-this.hdr_size-4)},l.saioBox.prototype.parse=function(t){this.parseFullHeader(t),1&this.flags&&(this.aux_info_type=t.readUint32(),this.aux_info_type_parameter=t.readUint32());var e=t.readUint32();this.offset=[];for(var i=0;e>i;i++)0===this.version?this.offset[i]=t.readUint32():this.offset[i]=t.readUint64()},l.saizBox.prototype.parse=function(t){this.parseFullHeader(t),1&this.flags&&(this.aux_info_type=t.readUint32(),this.aux_info_type_parameter=t.readUint32()),this.default_sample_info_size=t.readUint8();var e=t.readUint32();if(this.sample_info_size=[],0===this.default_sample_info_size)for(var i=0;e>i;i++)this.sample_info_size[i]=t.readUint8()},l.mettSampleEntry.prototype.parse=function(t){this.parseHeader(t),this.content_encoding=t.readCString(),this.mime_format=t.readCString(),this.parseFooter(t)},l.metxSampleEntry.prototype.parse=function(t){this.parseHeader(t),this.content_encoding=t.readCString(),this.namespace=t.readCString(),this.schema_location=t.readCString(),this.parseFooter(t)},l.SampleEntry.prototype.parseHeader=function(t){t.readUint8Array(6),this.data_reference_index=t.readUint16(),this.hdr_size+=8},l.SampleEntry.prototype.parse=function(t){this.parseHeader(t),this.data=t.readUint8Array(this.size-this.hdr_size)},l.SampleEntry.prototype.parseDataAndRewind=function(t){this.parseHeader(t),this.data=t.readUint8Array(this.size-this.hdr_size),this.hdr_size-=8,t.position-=this.size-this.hdr_size},l.SampleEntry.prototype.parseFooter=function(t){for(var e,i;t.getPosition()<this.start+this.size;){if((e=l.parseOneBox(t,!1,this.size-(t.getPosition()-this.start))).code!==l.OK)return;i=e.box,this.boxes.push(i),this[i.type]=i}},l.VisualSampleEntry.prototype.parse=function(t){this.parseHeader(t),t.readUint16(),t.readUint16(),t.readUint32Array(3),this.width=t.readUint16(),this.height=t.readUint16(),this.horizresolution=t.readUint32(),this.vertresolution=t.readUint32(),t.readUint32(),this.frame_count=t.readUint16(),this.compressorname=t.readString(32),this.depth=t.readUint16(),t.readUint16(),this.parseFooter(t)},l.AudioSampleEntry.prototype.parse=function(t){this.parseHeader(t),t.readUint32Array(2),this.channel_count=t.readUint16(),this.samplesize=t.readUint16(),t.readUint16(),t.readUint16(),this.samplerate=t.readUint32()/65536,this.parseFooter(t)},l.sbttSampleEntry.prototype.parse=function(t){this.parseHeader(t),this.content_encoding=t.readCString(),this.mime_format=t.readCString(),this.parseFooter(t)},l.stppSampleEntry.prototype.parse=function(t){this.parseHeader(t),this.namespace=t.readCString(),this.schema_location=t.readCString(),this.auxiliary_mime_types=t.readCString(),this.parseFooter(t)},l.stxtSampleEntry.prototype.parse=function(t){this.parseHeader(t),this.content_encoding=t.readCString(),this.mime_format=t.readCString(),this.parseFooter(t)},l.tx3gSampleEntry.prototype.parse=function(t){this.parseHeader(t),this.displayFlags=t.readUint32(),this.horizontal_justification=t.readInt8(),this.vertical_justification=t.readInt8(),this.bg_color_rgba=t.readUint8Array(4),this.box_record=t.readInt16Array(4),this.style_record=t.readUint8Array(12),this.parseFooter(t)},l.wvttSampleEntry.prototype.parse=function(t){this.parseHeader(t),this.parseFooter(t)},l.alstSampleGroupEntry.prototype.parse=function(t){var e,i=t.readUint16();for(this.first_output_sample=t.readUint16(),this.sample_offset=[],e=0;i>e;e++)this.sample_offset[e]=t.readUint32();var s=this.description_length-4-4*i;for(this.num_output_samples=[],this.num_total_samples=[],e=0;s/4>e;e++)this.num_output_samples[e]=t.readUint16(),this.num_total_samples[e]=t.readUint16()},l.avllSampleGroupEntry.prototype.parse=function(t){this.layerNumber=t.readUint8(),this.accurateStatisticsFlag=t.readUint8(),this.avgBitRate=t.readUint16(),this.avgFrameRate=t.readUint16()},l.avssSampleGroupEntry.prototype.parse=function(t){this.subSequenceIdentifier=t.readUint16(),this.layerNumber=t.readUint8();var e=t.readUint8();this.durationFlag=e>>7,this.avgRateFlag=e>>6&1,this.durationFlag&&(this.duration=t.readUint32()),this.avgRateFlag&&(this.accurateStatisticsFlag=t.readUint8(),this.avgBitRate=t.readUint16(),this.avgFrameRate=t.readUint16()),this.dependency=[];for(var i=t.readUint8(),s=0;i>s;s++){var r={};this.dependency.push(r),r.subSeqDirectionFlag=t.readUint8(),r.layerNumber=t.readUint8(),r.subSequenceIdentifier=t.readUint16()}},l.dtrtSampleGroupEntry.prototype.parse=function(t){a.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")},l.mvifSampleGroupEntry.prototype.parse=function(t){a.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")},l.prolSampleGroupEntry.prototype.parse=function(t){this.roll_distance=t.readInt16()},l["rap SampleGroupEntry"].prototype.parse=function(t){var e=t.readUint8();this.num_leading_samples_known=e>>7,this.num_leading_samples=127&e},l.rashSampleGroupEntry.prototype.parse=function(t){if(this.operation_point_count=t.readUint16(),this.description_length!==2+(1===this.operation_point_count?2:6*this.operation_point_count)+9)a.warn("BoxParser","Mismatch in "+this.grouping_type+" sample group length"),this.data=t.readUint8Array(this.description_length-2);else{if(1===this.operation_point_count)this.target_rate_share=t.readUint16();else{this.target_rate_share=[],this.available_bitrate=[];for(var e=0;e<this.operation_point_count;e++)this.available_bitrate[e]=t.readUint32(),this.target_rate_share[e]=t.readUint16()}this.maximum_bitrate=t.readUint32(),this.minimum_bitrate=t.readUint32(),this.discard_priority=t.readUint8()}},l.rollSampleGroupEntry.prototype.parse=function(t){this.roll_distance=t.readInt16()},l.SampleGroupEntry.prototype.parse=function(t){a.warn("BoxParser","Unknown Sample Group type: "+this.grouping_type),this.data=t.readUint8Array(this.description_length)},l.scifSampleGroupEntry.prototype.parse=function(t){a.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")},l.scnmSampleGroupEntry.prototype.parse=function(t){a.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")},l.stsaSampleGroupEntry.prototype.parse=function(t){a.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")},l.syncSampleGroupEntry.prototype.parse=function(t){var e=t.readUint8();this.NAL_unit_type=63&e},l.teleSampleGroupEntry.prototype.parse=function(t){var e=t.readUint8();this.level_independently_decodable=e>>7},l.tsasSampleGroupEntry.prototype.parse=function(t){a.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")},l.tsclSampleGroupEntry.prototype.parse=function(t){a.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")},l.viprSampleGroupEntry.prototype.parse=function(t){a.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")},l.sbgpBox.prototype.parse=function(t){this.parseFullHeader(t),this.grouping_type=t.readString(4),1===this.version?this.grouping_type_parameter=t.readUint32():this.grouping_type_parameter=0,this.entries=[];for(var e=t.readUint32(),i=0;e>i;i++){var s={};this.entries.push(s),s.sample_count=t.readInt32(),s.group_description_index=t.readInt32()}},l.schmBox.prototype.parse=function(t){this.parseFullHeader(t),this.scheme_type=t.readString(4),this.scheme_version=t.readUint32(),1&this.flags&&(this.scheme_uri=t.readString(this.size-this.hdr_size-8))},l["sdp Box"].prototype.parse=function(t){this.sdptext=t.readString(this.size-this.hdr_size)},l.sdtpBox.prototype.parse=function(t){var e;this.parseFullHeader(t);var i=this.size-this.hdr_size;this.is_leading=[],this.sample_depends_on=[],this.sample_is_depended_on=[],this.sample_has_redundancy=[];for(var s=0;i>s;s++)e=t.readUint8(),this.is_leading[s]=e>>6,this.sample_depends_on[s]=e>>4&3,this.sample_is_depended_on[s]=e>>2&3,this.sample_has_redundancy[s]=3&e},l.sgpdBox.prototype.parse=function(t){this.parseFullHeader(t),this.grouping_type=t.readString(4),a.debug("BoxParser","Found Sample Groups of type "+this.grouping_type),1===this.version?this.default_length=t.readUint32():this.default_length=0,this.version>=2&&(this.default_group_description_index=t.readUint32()),this.entries=[];for(var e=t.readUint32(),i=0;e>i;i++){var s;s=l[this.grouping_type+"SampleGroupEntry"]?new l[this.grouping_type+"SampleGroupEntry"](this.grouping_type):new l.SampleGroupEntry(this.grouping_type),this.entries.push(s),1===this.version&&0===this.default_length?s.description_length=t.readUint32():s.description_length=this.default_length,s.write===l.SampleGroupEntry.prototype.write&&(a.warn("BoxParser"," SampleEntry for type "+this.grouping_type+" writing not yet implemented, keeping unparsed data in memory for later write"),s.data=t.readUint8Array(s.description_length),t.position-=s.description_length),s.parse(t)}},l.sidxBox.prototype.parse=function(t){this.parseFullHeader(t),this.reference_ID=t.readUint32(),this.timescale=t.readUint32(),0===this.version?(this.earliest_presentation_time=t.readUint32(),this.first_offset=t.readUint32()):(this.earliest_presentation_time=t.readUint64(),this.first_offset=t.readUint64()),t.readUint16(),this.references=[];for(var e=t.readUint16(),i=0;e>i;i++){var s={};this.references.push(s);var r=t.readUint32();s.reference_type=r>>31&1,s.referenced_size=2147483647&r,s.subsegment_duration=t.readUint32(),r=t.readUint32(),s.starts_with_SAP=r>>31&1,s.SAP_type=r>>28&7,s.SAP_delta_time=268435455&r}},l.SingleItemTypeReferenceBox=function(t,e,i,s){l.Box.call(this,t,e),this.hdr_size=i,this.start=s},l.SingleItemTypeReferenceBox.prototype=new l.Box,l.SingleItemTypeReferenceBox.prototype.parse=function(t){this.from_item_ID=t.readUint16();var e=t.readUint16();this.references=[];for(var i=0;e>i;i++)this.references[i]=t.readUint16()},l.SingleItemTypeReferenceBoxLarge=function(t,e,i,s){l.Box.call(this,t,e),this.hdr_size=i,this.start=s},l.SingleItemTypeReferenceBoxLarge.prototype=new l.Box,l.SingleItemTypeReferenceBoxLarge.prototype.parse=function(t){this.from_item_ID=t.readUint32();var e=t.readUint16();this.references=[];for(var i=0;e>i;i++)this.references[i]=t.readUint32()},l.ssixBox.prototype.parse=function(t){this.parseFullHeader(t),this.subsegments=[];for(var e=t.readUint32(),i=0;e>i;i++){var s={};this.subsegments.push(s),s.ranges=[];for(var r=t.readUint32(),n=0;r>n;n++){var a={};s.ranges.push(a),a.level=t.readUint8(),a.range_size=t.readUint24()}}},l.stcoBox.prototype.parse=function(t){var e;this.parseFullHeader(t),e=t.readUint32(),0===this.version&&(this.chunk_offsets=t.readUint32Array(e))},l.stdpBox.prototype.parse=function(t){this.parseFullHeader(t);var e=(this.size-this.hdr_size)/2;this.priority=[];for(var i=0;e>i;i++)this.priority[i]=t.readUint16()},l.striBox.prototype.parse=function(t){this.parseFullHeader(t),this.switch_group=t.readUint16(),this.alternate_group=t.readUint16(),this.sub_track_id=t.readUint32();var e=(this.size-this.hdr_size-8)/4;this.attribute_list=[];for(var i=0;e>i;i++)this.attribute_list[i]=t.readUint32()},l.stscBox.prototype.parse=function(t){var e,i;if(this.parseFullHeader(t),e=t.readUint32(),this.first_chunk=[],this.samples_per_chunk=[],this.sample_description_index=[],0===this.version)for(i=0;e>i;i++)this.first_chunk.push(t.readUint32()),this.samples_per_chunk.push(t.readUint32()),this.sample_description_index.push(t.readUint32())},l.stsdBox=function(t){l.FullBox.call(this,"stsd",t),this.entries=[]},l.stsdBox.prototype=new l.FullBox,l.stsdBox.prototype.parse=function(t){var e,i,s,r;for(this.parseFullHeader(t),s=t.readUint32(),e=1;s>=e;e++){if((i=l.parseOneBox(t,!0,this.size-(t.getPosition()-this.start))).code!==l.OK)return;l[i.type+"SampleEntry"]?((r=new l[i.type+"SampleEntry"](i.size)).hdr_size=i.hdr_size,r.start=i.start):(a.warn("BoxParser","Unknown sample entry type: "+i.type),r=new l.SampleEntry(i.type,i.size,i.hdr_size,i.start)),r.write===l.SampleEntry.prototype.write&&(a.warn("BoxParser",r.type+" box writing not yet implemented, keeping unparsed data in memory for later write"),r.parseDataAndRewind(t)),r.parse(t),this.entries.push(r)}},l.stsgBox.prototype.parse=function(t){this.parseFullHeader(t),this.grouping_type=t.readUint32();var e=t.readUint16();this.group_description_index=[];for(var i=0;e>i;i++)this.group_description_index[i]=t.readUint32()},l.stshBox.prototype.parse=function(t){var e,i;if(this.parseFullHeader(t),e=t.readUint32(),this.shadowed_sample_numbers=[],this.sync_sample_numbers=[],0===this.version)for(i=0;e>i;i++)this.shadowed_sample_numbers.push(t.readUint32()),this.sync_sample_numbers.push(t.readUint32())},l.stssBox.prototype.parse=function(t){var e,i;if(this.parseFullHeader(t),i=t.readUint32(),0===this.version)for(this.sample_numbers=[],e=0;i>e;e++)this.sample_numbers.push(t.readUint32())},l.stszBox.prototype.parse=function(t){var e;if(this.parseFullHeader(t),this.sample_sizes=[],0===this.version)if(this.sample_size=t.readUint32(),this.sample_count=t.readUint32(),0===this.sample_size)this.sample_sizes=t.readUint32Array(this.sample_count);else for(e=0;e<this.sample_count;e++)this.sample_sizes[e]=this.sample_size},l.sttsBox.prototype.parse=function(t){var e,i,s;if(this.parseFullHeader(t),e=t.readUint32(),this.sample_counts=[],this.sample_deltas=[],0===this.version)for(i=0;e>i;i++)this.sample_counts.push(t.readUint32()),0>(s=t.readInt32())&&(a.warn("BoxParser","File uses negative stts sample delta, using value 1 instead, sync may be lost!"),s=1),this.sample_deltas.push(s)},l.stviBox.prototype.parse=function(t){this.parseFullHeader(t);var e=t.readUint32();this.single_view_allowed=3&e,this.stereo_scheme=t.readUint32();var i,s,r=t.readUint32();for(this.stereo_indication_type=t.readString(r),this.boxes=[];t.getPosition()<this.start+this.size;){if((i=l.parseOneBox(t,!1,this.size-(t.getPosition()-this.start))).code!==l.OK)return;s=i.box,this.boxes.push(s),this[s.type]=s}},l.stypBox.prototype.parse=function(t){l.ftypBox.prototype.parse.call(this,t)},l.stz2Box.prototype.parse=function(t){var e,i;if(this.parseFullHeader(t),this.sample_sizes=[],0===this.version)if(this.reserved=t.readUint24(),this.field_size=t.readUint8(),i=t.readUint32(),4===this.field_size)for(e=0;i>e;e+=2){var s=t.readUint8();this.sample_sizes[e]=s>>4&15,this.sample_sizes[e+1]=15&s}else if(8===this.field_size)for(e=0;i>e;e++)this.sample_sizes[e]=t.readUint8();else if(16===this.field_size)for(e=0;i>e;e++)this.sample_sizes[e]=t.readUint16();else a.error("BoxParser","Error in length field in stz2 box")},l.subsBox.prototype.parse=function(t){var e,i,s,r;for(this.parseFullHeader(t),s=t.readUint32(),this.entries=[],e=0;s>e;e++){var n={};if(this.entries[e]=n,n.sample_delta=t.readUint32(),n.subsamples=[],(r=t.readUint16())>0)for(i=0;r>i;i++){var a={};n.subsamples.push(a),1==this.version?a.size=t.readUint32():a.size=t.readUint16(),a.priority=t.readUint8(),a.discardable=t.readUint8(),a.codec_specific_parameters=t.readUint32()}}},l.tfdtBox.prototype.parse=function(t){this.parseFullHeader(t),1==this.version?this.baseMediaDecodeTime=t.readUint64():this.baseMediaDecodeTime=t.readUint32()},l.tfhdBox.prototype.parse=function(t){var e=0;this.parseFullHeader(t),this.track_id=t.readUint32(),this.size-this.hdr_size>e&&this.flags&l.TFHD_FLAG_BASE_DATA_OFFSET?(this.base_data_offset=t.readUint64(),e+=8):this.base_data_offset=0,this.size-this.hdr_size>e&&this.flags&l.TFHD_FLAG_SAMPLE_DESC?(this.default_sample_description_index=t.readUint32(),e+=4):this.default_sample_description_index=0,this.size-this.hdr_size>e&&this.flags&l.TFHD_FLAG_SAMPLE_DUR?(this.default_sample_duration=t.readUint32(),e+=4):this.default_sample_duration=0,this.size-this.hdr_size>e&&this.flags&l.TFHD_FLAG_SAMPLE_SIZE?(this.default_sample_size=t.readUint32(),e+=4):this.default_sample_size=0,this.size-this.hdr_size>e&&this.flags&l.TFHD_FLAG_SAMPLE_FLAGS?(this.default_sample_flags=t.readUint32(),e+=4):this.default_sample_flags=0},l.tfraBox.prototype.parse=function(t){this.parseFullHeader(t),this.track_ID=t.readUint32(),t.readUint24();var e=t.readUint8();this.length_size_of_traf_num=e>>4&3,this.length_size_of_trun_num=e>>2&3,this.length_size_of_sample_num=3&e,this.entries=[];for(var i=t.readUint32(),s=0;i>s;s++)1===this.version?(this.time=t.readUint64(),this.moof_offset=t.readUint64()):(this.time=t.readUint32(),this.moof_offset=t.readUint32()),this.traf_number=t["readUint"+8*(this.length_size_of_traf_num+1)](),this.trun_number=t["readUint"+8*(this.length_size_of_trun_num+1)](),this.sample_number=t["readUint"+8*(this.length_size_of_sample_num+1)]()},l.tkhdBox.prototype.parse=function(t){this.parseFullHeader(t),1==this.version?(this.creation_time=t.readUint64(),this.modification_time=t.readUint64(),this.track_id=t.readUint32(),t.readUint32(),this.duration=t.readUint64()):(this.creation_time=t.readUint32(),this.modification_time=t.readUint32(),this.track_id=t.readUint32(),t.readUint32(),this.duration=t.readUint32()),t.readUint32Array(2),this.layer=t.readInt16(),this.alternate_group=t.readInt16(),this.volume=t.readInt16()>>8,t.readUint16(),this.matrix=t.readInt32Array(9),this.width=t.readUint32(),this.height=t.readUint32()},l.tmaxBox.prototype.parse=function(t){this.time=t.readUint32()},l.tminBox.prototype.parse=function(t){this.time=t.readUint32()},l.totlBox.prototype.parse=function(t){this.bytessent=t.readUint32()},l.tpayBox.prototype.parse=function(t){this.bytessent=t.readUint32()},l.tpylBox.prototype.parse=function(t){this.bytessent=t.readUint64()},l.trefBox.prototype.parse=function(t){for(var e,i;t.getPosition()<this.start+this.size;){if((e=l.parseOneBox(t,!0,this.size-(t.getPosition()-this.start))).code!==l.OK)return;(i=new l.TrackReferenceTypeBox(e.type,e.size,e.hdr_size,e.start)).write===l.Box.prototype.write&&"mdat"!==i.type&&(a.warn("BoxParser",i.type+" box writing not yet implemented, keeping unparsed data in memory for later write"),i.parseDataAndRewind(t)),i.parse(t),this.boxes.push(i)}},l.trepBox.prototype.parse=function(t){for(this.parseFullHeader(t),this.track_ID=t.readUint32(),this.boxes=[];t.getPosition()<this.start+this.size;){if(ret=l.parseOneBox(t,!1,this.size-(t.getPosition()-this.start)),ret.code!==l.OK)return;box=ret.box,this.boxes.push(box)}},l.trexBox.prototype.parse=function(t){this.parseFullHeader(t),this.track_id=t.readUint32(),this.default_sample_description_index=t.readUint32(),this.default_sample_duration=t.readUint32(),this.default_sample_size=t.readUint32(),this.default_sample_flags=t.readUint32()},l.trpyBox.prototype.parse=function(t){this.bytessent=t.readUint64()},l.trunBox.prototype.parse=function(t){var e=0;if(this.parseFullHeader(t),this.sample_count=t.readUint32(),e+=4,this.size-this.hdr_size>e&&this.flags&l.TRUN_FLAGS_DATA_OFFSET?(this.data_offset=t.readInt32(),e+=4):this.data_offset=0,this.size-this.hdr_size>e&&this.flags&l.TRUN_FLAGS_FIRST_FLAG?(this.first_sample_flags=t.readUint32(),e+=4):this.first_sample_flags=0,this.sample_duration=[],this.sample_size=[],this.sample_flags=[],this.sample_composition_time_offset=[],this.size-this.hdr_size>e)for(var i=0;i<this.sample_count;i++)this.flags&l.TRUN_FLAGS_DURATION&&(this.sample_duration[i]=t.readUint32()),this.flags&l.TRUN_FLAGS_SIZE&&(this.sample_size[i]=t.readUint32()),this.flags&l.TRUN_FLAGS_FLAGS&&(this.sample_flags[i]=t.readUint32()),this.flags&l.TRUN_FLAGS_CTS_OFFSET&&(0===this.version?this.sample_composition_time_offset[i]=t.readUint32():this.sample_composition_time_offset[i]=t.readInt32())},l.tselBox.prototype.parse=function(t){this.parseFullHeader(t),this.switch_group=t.readUint32();var e=(this.size-this.hdr_size-4)/4;this.attribute_list=[];for(var i=0;e>i;i++)this.attribute_list[i]=t.readUint32()},l.txtCBox.prototype.parse=function(t){this.parseFullHeader(t),this.config=t.readCString()},l["url Box"].prototype.parse=function(t){this.parseFullHeader(t),1!==this.flags&&(this.location=t.readCString())},l["urn Box"].prototype.parse=function(t){this.parseFullHeader(t),this.name=t.readCString(),this.size-this.hdr_size-this.name.length-1>0&&(this.location=t.readCString())},l.vmhdBox.prototype.parse=function(t){this.parseFullHeader(t),this.graphicsmode=t.readUint16(),this.opcolor=t.readUint16Array(3)},l.vttCBox.prototype.parse=function(t){this.text=t.readString(this.size-this.hdr_size)},l.Box.prototype.writeHeader=function(t,e){this.size+=8,this.size>p&&(this.size+=8),"uuid"===this.type&&(this.size+=16),a.debug("BoxWriter","Writing box "+this.type+" of size: "+this.size+" at position "+t.getPosition()+(e||"")),this.size>p?t.writeUint32(1):(this.sizePosition=t.getPosition(),t.writeUint32(this.size)),t.writeString(this.type,null,4),"uuid"===this.type&&t.writeUint8Array(this.uuid),this.size>p&&t.writeUint64(this.size)},l.FullBox.prototype.writeHeader=function(t){this.size+=4,l.Box.prototype.writeHeader.call(this,t," v="+this.version+" f="+this.flags),t.writeUint8(this.version),t.writeUint24(this.flags)},l.Box.prototype.write=function(t){"mdat"===this.type?this.data&&(this.size=this.data.length,this.writeHeader(t),t.writeUint8Array(this.data)):(this.size=this.data?this.data.length:0,this.writeHeader(t),this.data&&t.writeUint8Array(this.data))},l.ContainerBox.prototype.write=function(t){this.size=0,this.writeHeader(t);for(var e=0;e<this.boxes.length;e++)this.boxes[e]&&(this.boxes[e].write(t),this.size+=this.boxes[e].size);a.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)},l.TrackReferenceTypeBox.prototype.write=function(t){this.size=4*this.track_ids.length,this.writeHeader(t),t.writeUint32Array(this.track_ids)},l.avcCBox.prototype.write=function(t){var e;for(this.size=7,e=0;e<this.SPS.length;e++)this.size+=2+this.SPS[e].length;for(e=0;e<this.PPS.length;e++)this.size+=2+this.PPS[e].length;for(this.ext&&(this.size+=this.ext.length),this.writeHeader(t),t.writeUint8(this.configurationVersion),t.writeUint8(this.AVCProfileIndication),t.writeUint8(this.profile_compatibility),t.writeUint8(this.AVCLevelIndication),t.writeUint8(this.lengthSizeMinusOne+252),t.writeUint8(this.SPS.length+224),e=0;e<this.SPS.length;e++)t.writeUint16(this.SPS[e].length),t.writeUint8Array(this.SPS[e]);for(t.writeUint8(this.PPS.length),e=0;e<this.PPS.length;e++)t.writeUint16(this.PPS[e].length),t.writeUint8Array(this.PPS[e]);this.ext&&t.writeUint8Array(this.ext)},l.co64Box.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=4+8*this.chunk_offsets.length,this.writeHeader(t),t.writeUint32(this.chunk_offsets.length),e=0;e<this.chunk_offsets.length;e++)t.writeUint64(this.chunk_offsets[e])},l.cslgBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=20,this.writeHeader(t),t.writeInt32(this.compositionToDTSShift),t.writeInt32(this.leastDecodeToDisplayDelta),t.writeInt32(this.greatestDecodeToDisplayDelta),t.writeInt32(this.compositionStartTime),t.writeInt32(this.compositionEndTime)},l.cttsBox.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=4+8*this.sample_counts.length,this.writeHeader(t),t.writeUint32(this.sample_counts.length),e=0;e<this.sample_counts.length;e++)t.writeUint32(this.sample_counts[e]),1===this.version?t.writeInt32(this.sample_offsets[e]):t.writeUint32(this.sample_offsets[e])},l.drefBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4,this.writeHeader(t),t.writeUint32(this.entries.length);for(var e=0;e<this.entries.length;e++)this.entries[e].write(t),this.size+=this.entries[e].size;a.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)},l.elngBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=this.extended_language.length,this.writeHeader(t),t.writeString(this.extended_language)},l.elstBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4+12*this.entries.length,this.writeHeader(t),t.writeUint32(this.entries.length);for(var e=0;e<this.entries.length;e++){var i=this.entries[e];t.writeUint32(i.segment_duration),t.writeInt32(i.media_time),t.writeInt16(i.media_rate_integer),t.writeInt16(i.media_rate_fraction)}},l.emsgBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=16+this.message_data.length+(this.scheme_id_uri.length+1)+(this.value.length+1),this.writeHeader(t),t.writeCString(this.scheme_id_uri),t.writeCString(this.value),t.writeUint32(this.timescale),t.writeUint32(this.presentation_time_delta),t.writeUint32(this.event_duration),t.writeUint32(this.id),t.writeUint8Array(this.message_data)},l.ftypBox.prototype.write=function(t){this.size=8+4*this.compatible_brands.length,this.writeHeader(t),t.writeString(this.major_brand,null,4),t.writeUint32(this.minor_version);for(var e=0;e<this.compatible_brands.length;e++)t.writeString(this.compatible_brands[e],null,4)},l.hdlrBox.prototype.write=function(t){this.size=20+this.name.length+1,this.version=0,this.flags=0,this.writeHeader(t),t.writeUint32(0),t.writeString(this.handler,null,4),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeCString(this.name)},l.kindBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=this.schemeURI.length+1+(this.value.length+1),this.writeHeader(t),t.writeCString(this.schemeURI),t.writeCString(this.value)},l.mdhdBox.prototype.write=function(t){this.size=20,this.flags=0,this.version=0,this.writeHeader(t),t.writeUint32(this.creation_time),t.writeUint32(this.modification_time),t.writeUint32(this.timescale),t.writeUint32(this.duration),t.writeUint16(this.language),t.writeUint16(0)},l.mehdBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4,this.writeHeader(t),t.writeUint32(this.fragment_duration)},l.mfhdBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4,this.writeHeader(t),t.writeUint32(this.sequence_number)},l.mvhdBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=96,this.writeHeader(t),t.writeUint32(this.creation_time),t.writeUint32(this.modification_time),t.writeUint32(this.timescale),t.writeUint32(this.duration),t.writeUint32(this.rate),t.writeUint16(this.volume<<8),t.writeUint16(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32Array(this.matrix),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(this.next_track_id)},l.SampleEntry.prototype.writeHeader=function(t){this.size=8,l.Box.prototype.writeHeader.call(this,t),t.writeUint8(0),t.writeUint8(0),t.writeUint8(0),t.writeUint8(0),t.writeUint8(0),t.writeUint8(0),t.writeUint16(this.data_reference_index)},l.SampleEntry.prototype.writeFooter=function(t){for(var e=0;e<this.boxes.length;e++)this.boxes[e].write(t),this.size+=this.boxes[e].size;a.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)},l.SampleEntry.prototype.write=function(t){this.writeHeader(t),t.writeUint8Array(this.data),this.size+=this.data.length,a.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)},l.VisualSampleEntry.prototype.write=function(t){this.writeHeader(t),this.size+=70,t.writeUint16(0),t.writeUint16(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint16(this.width),t.writeUint16(this.height),t.writeUint32(this.horizresolution),t.writeUint32(this.vertresolution),t.writeUint32(0),t.writeUint16(this.frame_count),t.writeString(this.compressorname,null,32),t.writeUint16(this.depth),t.writeInt16(-1),this.writeFooter(t)},l.AudioSampleEntry.prototype.write=function(t){this.writeHeader(t),this.size+=20,t.writeUint32(0),t.writeUint32(0),t.writeUint16(this.channel_count),t.writeUint16(this.samplesize),t.writeUint16(0),t.writeUint16(0),t.writeUint32(this.samplerate<<16),this.writeFooter(t)},l.SampleGroupEntry.prototype.write=function(t){t.writeUint8Array(this.data)},l.sbgpBox.prototype.write=function(t){this.version=1,this.flags=0,this.size=12+8*this.entries.length,this.writeHeader(t),t.writeString(this.grouping_type,null,4),t.writeUint32(this.grouping_type_parameter),t.writeUint32(this.entries.length);for(var e=0;e<this.entries.length;e++){var i=this.entries[e];t.writeInt32(i.sample_count),t.writeInt32(i.group_description_index)}},l.sgpdBox.prototype.write=function(t){var e,i;for(this.flags=0,this.size=12,e=0;e<this.entries.length;e++)i=this.entries[e],1===this.version&&(0===this.default_length&&(this.size+=4),this.size+=i.data.length);for(this.writeHeader(t),t.writeString(this.grouping_type,null,4),1===this.version&&t.writeUint32(this.default_length),this.version>=2&&t.writeUint32(this.default_sample_description_index),t.writeUint32(this.entries.length),e=0;e<this.entries.length;e++)i=this.entries[e],1===this.version&&0===this.default_length&&t.writeUint32(i.description_length),i.write(t)},l.sidxBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=20+12*this.references.length,this.writeHeader(t),t.writeUint32(this.reference_ID),t.writeUint32(this.timescale),t.writeUint32(this.earliest_presentation_time),t.writeUint32(this.first_offset),t.writeUint16(0),t.writeUint16(this.references.length);for(var e=0;e<this.references.length;e++){var i=this.references[e];t.writeUint32(i.reference_type<<31|i.referenced_size),t.writeUint32(i.subsegment_duration),t.writeUint32(i.starts_with_SAP<<31|i.SAP_type<<28|i.SAP_delta_time)}},l.stcoBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4+4*this.chunk_offsets.length,this.writeHeader(t),t.writeUint32(this.chunk_offsets.length),t.writeUint32Array(this.chunk_offsets)},l.stscBox.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=4+12*this.first_chunk.length,this.writeHeader(t),t.writeUint32(this.first_chunk.length),e=0;e<this.first_chunk.length;e++)t.writeUint32(this.first_chunk[e]),t.writeUint32(this.samples_per_chunk[e]),t.writeUint32(this.sample_description_index[e])},l.stsdBox.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=0,this.writeHeader(t),t.writeUint32(this.entries.length),this.size+=4,e=0;e<this.entries.length;e++)this.entries[e].write(t),this.size+=this.entries[e].size;a.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)},l.stshBox.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=4+8*this.shadowed_sample_numbers.length,this.writeHeader(t),t.writeUint32(this.shadowed_sample_numbers.length),e=0;e<this.shadowed_sample_numbers.length;e++)t.writeUint32(this.shadowed_sample_numbers[e]),t.writeUint32(this.sync_sample_numbers[e])},l.stssBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4+4*this.sample_numbers.length,this.writeHeader(t),t.writeUint32(this.sample_numbers.length),t.writeUint32Array(this.sample_numbers)},l.stszBox.prototype.write=function(t){var e,i=!0;if(this.version=0,this.flags=0,this.sample_sizes.length>0)for(e=0;e+1<this.sample_sizes.length;){if(this.sample_sizes[e+1]!==this.sample_sizes[0]){i=!1;break}e++}else i=!1;this.size=8,i||(this.size+=4*this.sample_sizes.length),this.writeHeader(t),i?t.writeUint32(this.sample_sizes[0]):t.writeUint32(0),t.writeUint32(this.sample_sizes.length),i||t.writeUint32Array(this.sample_sizes)},l.sttsBox.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=4+8*this.sample_counts.length,this.writeHeader(t),t.writeUint32(this.sample_counts.length),e=0;e<this.sample_counts.length;e++)t.writeUint32(this.sample_counts[e]),t.writeUint32(this.sample_deltas[e])},l.tfdtBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4,1===this.version&&(this.size+=4),this.writeHeader(t),1===this.version?t.writeUint64(this.baseMediaDecodeTime):t.writeUint32(this.baseMediaDecodeTime)},l.tfhdBox.prototype.write=function(t){this.version=0,this.size=4,this.flags&l.TFHD_FLAG_BASE_DATA_OFFSET&&(this.size+=8),this.flags&l.TFHD_FLAG_SAMPLE_DESC&&(this.size+=4),this.flags&l.TFHD_FLAG_SAMPLE_DUR&&(this.size+=4),this.flags&l.TFHD_FLAG_SAMPLE_SIZE&&(this.size+=4),this.flags&l.TFHD_FLAG_SAMPLE_FLAGS&&(this.size+=4),this.writeHeader(t),t.writeUint32(this.track_id),this.flags&l.TFHD_FLAG_BASE_DATA_OFFSET&&t.writeUint64(this.base_data_offset),this.flags&l.TFHD_FLAG_SAMPLE_DESC&&t.writeUint32(this.default_sample_description_index),this.flags&l.TFHD_FLAG_SAMPLE_DUR&&t.writeUint32(this.default_sample_duration),this.flags&l.TFHD_FLAG_SAMPLE_SIZE&&t.writeUint32(this.default_sample_size),this.flags&l.TFHD_FLAG_SAMPLE_FLAGS&&t.writeUint32(this.default_sample_flags)},l.tkhdBox.prototype.write=function(t){this.version=0,this.size=80,this.writeHeader(t),t.writeUint32(this.creation_time),t.writeUint32(this.modification_time),t.writeUint32(this.track_id),t.writeUint32(0),t.writeUint32(this.duration),t.writeUint32(0),t.writeUint32(0),t.writeInt16(this.layer),t.writeInt16(this.alternate_group),t.writeInt16(this.volume<<8),t.writeUint16(0),t.writeInt32Array(this.matrix),t.writeUint32(this.width),t.writeUint32(this.height)},l.trexBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=20,this.writeHeader(t),t.writeUint32(this.track_id),t.writeUint32(this.default_sample_description_index),t.writeUint32(this.default_sample_duration),t.writeUint32(this.default_sample_size),t.writeUint32(this.default_sample_flags)},l.trunBox.prototype.write=function(t){this.version=0,this.size=4,this.flags&l.TRUN_FLAGS_DATA_OFFSET&&(this.size+=4),this.flags&l.TRUN_FLAGS_FIRST_FLAG&&(this.size+=4),this.flags&l.TRUN_FLAGS_DURATION&&(this.size+=4*this.sample_duration.length),this.flags&l.TRUN_FLAGS_SIZE&&(this.size+=4*this.sample_size.length),this.flags&l.TRUN_FLAGS_FLAGS&&(this.size+=4*this.sample_flags.length),this.flags&l.TRUN_FLAGS_CTS_OFFSET&&(this.size+=4*this.sample_composition_time_offset.length),this.writeHeader(t),t.writeUint32(this.sample_count),this.flags&l.TRUN_FLAGS_DATA_OFFSET&&(this.data_offset_position=t.getPosition(),t.writeInt32(this.data_offset)),this.flags&l.TRUN_FLAGS_FIRST_FLAG&&t.writeUint32(this.first_sample_flags);for(var e=0;e<this.sample_count;e++)this.flags&l.TRUN_FLAGS_DURATION&&t.writeUint32(this.sample_duration[e]),this.flags&l.TRUN_FLAGS_SIZE&&t.writeUint32(this.sample_size[e]),this.flags&l.TRUN_FLAGS_FLAGS&&t.writeUint32(this.sample_flags[e]),this.flags&l.TRUN_FLAGS_CTS_OFFSET&&(0===this.version?t.writeUint32(this.sample_composition_time_offset[e]):t.writeInt32(this.sample_composition_time_offset[e]))},l["url Box"].prototype.write=function(t){this.version=0,this.location?(this.flags=0,this.size=this.location.length+1):(this.flags=1,this.size=0),this.writeHeader(t),this.location&&t.writeCString(this.location)},l["urn Box"].prototype.write=function(t){this.version=0,this.flags=0,this.size=this.name.length+1+(this.location?this.location.length+1:0),this.writeHeader(t),t.writeCString(this.name),this.location&&t.writeCString(this.location)},l.vmhdBox.prototype.write=function(t){this.version=0,this.flags=1,this.size=8,this.writeHeader(t),t.writeUint16(this.graphicsmode),t.writeUint16Array(this.opcolor)},l.cttsBox.prototype.unpack=function(t){var e,i,s;for(s=0,e=0;e<this.sample_counts.length;e++)for(i=0;i<this.sample_counts[e];i++)t[s].pts=t[s].dts+this.sample_offsets[e],s++},l.sttsBox.prototype.unpack=function(t){var e,i,s;for(s=0,e=0;e<this.sample_counts.length;e++)for(i=0;i<this.sample_counts[e];i++)t[s].dts=0===s?0:t[s-1].dts+this.sample_deltas[e],s++},l.stcoBox.prototype.unpack=function(t){var e;for(e=0;e<this.chunk_offsets.length;e++)t[e].offset=this.chunk_offsets[e]},l.stscBox.prototype.unpack=function(t){var e,i,s,r,n;for(r=0,n=0,e=0;e<this.first_chunk.length;e++)for(i=0;i<(e+1<this.first_chunk.length?this.first_chunk[e+1]:1/0);i++)for(n++,s=0;s<this.samples_per_chunk[e];s++){if(!t[r])return;t[r].description_index=this.sample_description_index[e],t[r].chunk_index=n,r++}},l.stszBox.prototype.unpack=function(t){var e;for(e=0;e<this.sample_sizes.length;e++)t[e].size=this.sample_sizes[e]};var u=function(){};u.prototype.parseSample=function(t){var e,i,s=new o(t.buffer);for(e=[];!s.isEos();)(i=l.parseOneBox(s,!1)).code===l.OK&&"vttc"===i.box.type&&e.push(i.box);return e},u.prototype.getText=function(t,e,i){function s(t,e,i){return i=i||"0",(t+="").length>=e?t:new Array(e-t.length+1).join(i)+t}function r(t){var e=Math.floor(t/3600),i=Math.floor((t-3600*e)/60),r=Math.floor(t-3600*e-60*i),n=Math.floor(1e3*(t-3600*e-60*i-r));return s(e,2)+":"+s(i,2)+":"+s(r,2)+"."+s(n,3)}for(var n=this.parseSample(i),a="",o=0;o<n.length;o++){var h=n[o];a+=r(t)+" --\x3e "+r(e)+"\r\n",a+=h.payl.text}return a};var m=function(){};m.prototype.parseSample=function(t){return new o(t.data.buffer).readString(t.data.length)},m.prototype.parseConfig=function(t){var e=new o(t.buffer);return e.readUint32(),e.readCString()};var c=function(t){this.stream=t,this.boxes=[],this.mdats=[],this.moofs=[],this.isProgressive=!1,this.moovStartFound=!1};c.prototype.parse=function(){var t,e;if(!this.restoreParsePosition||this.restoreParsePosition())for(;;){if(this.hasIncompleteMdat&&this.hasIncompleteMdat()){if(this.processIncompleteMdat())continue;return}if(this.saveParsePosition&&this.saveParsePosition(),(t=l.parseOneBox(this.stream,!1)).code===l.ERR_NOT_ENOUGH_DATA){if(this.processIncompleteBox){if(this.processIncompleteBox(t))continue;return}return}switch(e=t.box,this.boxes.push(e),e.type){case"mdat":this.mdats.push(e);break;case"moof":this.moofs.push(e);break;case"moov":this.moovStartFound=!0,0===this.mdats.length&&(this.isProgressive=!0);default:void 0!==this[e.type]&&a.warn("ISOFile","Duplicate Box of type: "+e.type+", overriding previous occurrence"),this[e.type]=e}this.updateUsedBytes&&this.updateUsedBytes(e,t)}},c.prototype.getBox=function(t){var e=this.getBoxes(t,!0);return e.length?e[0]:null},c.prototype.getBoxes=function(t,e){var i=[];return c._sweep.call(this,t,i,e),i},c._sweep=function(t,e,i){for(var s in this.type&&this.type==t&&e.push(this),this.boxes){if(e.length&&i)return;c._sweep.call(this.boxes[s],t,e,i)}},"undefined"!=typeof exports&&(exports.ISOFile=c),c.prototype.lastBoxStartPosition=0,c.prototype.parsingMdat=null,c.prototype.nextParsePosition=0,c.prototype.discardMdatData=!1,c.prototype.processIncompleteBox=function(t){var e;return"mdat"===t.type?(e=new l[t.type+"Box"](t.size),this.parsingMdat=e,this.boxes.push(e),this.mdats.push(e),e.start=t.start,e.hdr_size=t.hdr_size,this.stream.addUsedBytes(e.hdr_size),this.lastBoxStartPosition=e.start+e.size,this.stream.seek(e.start+e.size,!1,this.discardMdatData)?(this.parsingMdat=null,!0):(this.moovStartFound?this.nextParsePosition=this.stream.findEndContiguousBuf():this.nextParsePosition=e.start+e.size,!1)):("moov"===t.type&&(this.moovStartFound=!0,0===this.mdats.length&&(this.isProgressive=!0)),this.stream.mergeNextBuffer()?(this.nextParsePosition=this.stream.getEndPosition(),!0):(t.type?this.moovStartFound?this.nextParsePosition=this.stream.getEndPosition():this.nextParsePosition=this.stream.getPosition()+t.size:this.nextParsePosition=this.stream.getEndPosition(),!1))},c.prototype.hasIncompleteMdat=function(){return null!==this.parsingMdat},c.prototype.processIncompleteMdat=function(){var t;return t=this.parsingMdat,this.stream.seek(t.start+t.size,!1,this.discardMdatData)?(a.debug("ISOFile","Found 'mdat' end in buffered data"),this.parsingMdat=null,!0):(this.nextParsePosition=this.stream.findEndContiguousBuf(),!1)},c.prototype.restoreParsePosition=function(){return this.stream.seek(this.lastBoxStartPosition,!0,this.discardMdatData)},c.prototype.saveParsePosition=function(){this.lastBoxStartPosition=this.stream.getPosition()},c.prototype.updateUsedBytes=function(t,e){"mdat"===t.type?(this.stream.addUsedBytes(t.hdr_size),this.discardMdatData&&this.stream.addUsedBytes(t.size-t.hdr_size)):this.stream.addUsedBytes(t.size)},c.prototype.add=l.Box.prototype.add,c.prototype.init=function(){var t=this.add("moov");return t.add("mvhd").set("timescale",600).set("rate",1).set("creation_time",0).set("modification_time",0).set("duration",0).set("volume",1).set("matrix",[0,0,0,0,0,0,0,0,0]).set("next_track_id",1),t.add("mvex"),this},c.prototype.addTrack=function(t){this.moov||this.init();var e=t||{};e.width=e.width||320,e.height=e.height||320,e.id=e.id||this.moov.mvhd.next_track_id,e.type=e.type||"avc1";var i=this.moov.add("trak");this.moov.mvhd.next_track_id=e.id+1,i.add("tkhd").set("creation_time",0).set("modification_time",0).set("track_id",e.id).set("duration",0).set("layer",0).set("alternate_group",0).set("volume",1).set("matrix",[0,0,0,0,0,0,0,0,0]).set("width",e.width).set("height",e.height);var s=i.add("mdia");s.add("mdhd").set("creation_time",0).set("modification_time",0).set("timescale",e.timescale||1).set("duration",0).set("language",e.language||0),s.add("hdlr").set("handler",e.hdlr||"vide").set("name",e.name||"Track created with MP4Box.js"),s.add("elng").set("extended_language",e.language||"fr-FR");for(var r=s.add("minf"),n=new l[e.type+"SampleEntry"],a="",o=0;o<l.sampleEntryCodes.length;o++){var h=l.sampleEntryCodes[o];if(h.types.indexOf(e.type)>-1){a=h.prefix;break}}switch(a){case"Visual":r.add("vmhd").set("graphicsmode",0).set("opcolor",[0,0,0]),n.set("width",e.width).set("height",e.height).set("horizresolution",72<<16).set("vertresolution",72<<16).set("frame_count",1).set("compressorname",e.type+" Compressor").set("depth",24),n.add("avcC").set("SPS",[]).set("PPS",[]).set("configurationVersion",0).set("AVCProfileIndication",0).set("profile_compatibility",0).set("AVCLevelIndication",0).set("lengthSizeMinusOne",0);break;case"Audio":r.add("smhd");break;case"Hint":r.add("hmhd");break;case"Subtitle":r.add("sthd");break;case"Metadata":case"System":r.add("nmhd");break;default:r.add("nmhd")}r.add("dinf").add("dref").addEntry((new l["url Box"]).set("flags",1));var p=s.add("stbl");return p.add("stsd").addEntry(n),p.add("stts").set("sample_counts",[]).set("sample_deltas",[]),p.add("stsc").set("first_chunk",[]).set("samples_per_chunk",[]).set("sample_description_index",[]),this.moov.mvex.add("trex").set("track_id",e.id).set("default_sample_description_index",e.default_sample_description_index||0).set("default_sample_duration",e.default_sample_duration||0).set("default_sample_size",e.default_sample_size||0).set("default_sample_flags",e.default_sample_flags||0),i},c.prototype.getBuffer=function(){var t=new h;return t.endianness=h.BIG_ENDIAN,this.write(t),t.buffer},c.prototype.addSample=function(t,e,i){},c.prototype.lastMoofIndex=0,c.prototype.samplesDataSize=0,c.prototype.resetTables=function(){var t,e,i,s,r,n;for(this.initial_duration=this.moov.mvhd.duration,this.moov.mvhd.duration=0,t=0;t<this.moov.traks.length;t++){(e=this.moov.traks[t]).tkhd.duration=0,e.mdia.mdhd.duration=0,(e.mdia.minf.stbl.stco||e.mdia.minf.stbl.co64).chunk_offsets=[],(i=e.mdia.minf.stbl.stsc).first_chunk=[],i.samples_per_chunk=[],i.sample_description_index=[],(e.mdia.minf.stbl.stsz||e.mdia.minf.stbl.stz2).sample_sizes=[],(s=e.mdia.minf.stbl.stts).sample_counts=[],s.sample_deltas=[],(r=e.mdia.minf.stbl.ctts)&&(r.sample_counts=[],r.sample_offsets=[]),n=e.mdia.minf.stbl.stss;var a=e.mdia.minf.stbl.boxes.indexOf(n);-1!=a&&(e.mdia.minf.stbl.boxes[a]=null)}},c.initSampleGroups=function(t,e,i,s,r){function n(t,e,i){this.grouping_type=t,this.grouping_type_parameter=e,this.sbgp=i,this.last_sample_in_run=-1,this.entry_index=-1}var a,o,h,p;for(e&&(e.sample_groups_info=[]),t.sample_groups_info||(t.sample_groups_info=[]),o=0;o<i.length;o++){for(p=i[o].grouping_type+"/"+i[o].grouping_type_parameter,h=new n(i[o].grouping_type,i[o].grouping_type_parameter,i[o]),e&&(e.sample_groups_info[p]=h),t.sample_groups_info[p]||(t.sample_groups_info[p]=h),a=0;a<s.length;a++)s[a].grouping_type===i[o].grouping_type&&(h.description=s[a],h.description.used=!0);if(r)for(a=0;a<r.length;a++)r[a].grouping_type===i[o].grouping_type&&(h.fragment_description=r[a],h.fragment_description.used=!0,h.is_fragment=!0)}if(e){if(r)for(o=0;o<r.length;o++)!r[o].used&&r[o].version>=2&&(p=r[o].grouping_type+"/0",(h=new n(r[o].grouping_type,0)).is_fragment=!0,e.sample_groups_info[p]||(e.sample_groups_info[p]=h))}else for(o=0;o<s.length;o++)!s[o].used&&s[o].version>=2&&(p=s[o].grouping_type+"/0",h=new n(s[o].grouping_type,0),t.sample_groups_info[p]||(t.sample_groups_info[p]=h))},c.setSampleGroupProperties=function(t,e,i,s){var r,n;for(r in e.sample_groups=[],s)if(e.sample_groups[r]={},e.sample_groups[r].grouping_type=s[r].grouping_type,e.sample_groups[r].grouping_type_parameter=s[r].grouping_type_parameter,i>=s[r].last_sample_in_run&&(s[r].last_sample_in_run<0&&(s[r].last_sample_in_run=0),s[r].entry_index++,s[r].entry_index<=s[r].sbgp.entries.length-1&&(s[r].last_sample_in_run+=s[r].sbgp.entries[s[r].entry_index].sample_count)),s[r].entry_index<=s[r].sbgp.entries.length-1?e.sample_groups[r].group_description_index=s[r].sbgp.entries[s[r].entry_index].group_description_index:e.sample_groups[r].group_description_index=-1,0!==e.sample_groups[r].group_description_index){var a;a=s[r].fragment_description?s[r].fragment_description:s[r].description,e.sample_groups[r].group_description_index>0?(n=e.sample_groups[r].group_description_index>65535?(e.sample_groups[r].group_description_index>>16)-1:e.sample_groups[r].group_description_index-1,a&&n>=0&&(e.sample_groups[r].description=a.entries[n])):a&&a.version>=2&&a.default_group_description_index>0&&(e.sample_groups[r].description=a.entries[a.default_group_description_index-1])}},c.process_sdtp=function(t,e,i){e&&(t?(e.is_leading=t.is_leading[i],e.depends_on=t.sample_depends_on[i],e.is_depended_on=t.sample_is_depended_on[i],e.has_redundancy=t.sample_has_redundancy[i]):(e.is_leading=0,e.depends_on=0,e.is_depended_on=0,e.has_redundancy=0))},c.prototype.buildSampleLists=function(){var t,e,i,s,r,n,a,o,h,p,d,f,l,u,m,_,g,y,b,v,U,S,x,w,B;for(t=0;t<this.moov.traks.length;t++)if((i=this.moov.traks[t]).samples=[],i.samples_duration=0,i.samples_size=0,s=i.mdia.minf.stbl.stco||i.mdia.minf.stbl.co64,r=i.mdia.minf.stbl.stsc,n=i.mdia.minf.stbl.stsz||i.mdia.minf.stbl.stz2,a=i.mdia.minf.stbl.stts,o=i.mdia.minf.stbl.ctts,h=i.mdia.minf.stbl.stss,p=i.mdia.minf.stbl.stsd,d=i.mdia.minf.stbl.subs,u=i.mdia.minf.stbl.stdp,f=i.mdia.minf.stbl.sbgps,l=i.mdia.minf.stbl.sgpds,v=-1,U=-1,S=-1,x=-1,w=0,0,B=0,c.initSampleGroups(i,null,f,l),void 0!==n){for(e=0;e<n.sample_sizes.length;e++){var z={};z.number=e,z.track_id=i.tkhd.track_id,z.timescale=i.mdia.mdhd.timescale,z.alreadyRead=0,i.samples[e]=z,z.size=n.sample_sizes[e],i.samples_size+=z.size,0===e?(_=1,m=0,z.chunk_index=_,z.chunk_run_index=m,b=r.samples_per_chunk[m],y=0,g=m+1<r.first_chunk.length?r.first_chunk[m+1]-1:1/0):b>e?(z.chunk_index=_,z.chunk_run_index=m):(_++,z.chunk_index=_,y=0,g>=_||(g=++m+1<r.first_chunk.length?r.first_chunk[m+1]-1:1/0),z.chunk_run_index=m,b+=r.samples_per_chunk[m]),z.description_index=r.sample_description_index[z.chunk_run_index]-1,z.description=p.entries[z.description_index],z.offset=s.chunk_offsets[z.chunk_index-1]+y,y+=z.size,e>v&&(U++,0>v&&(v=0),v+=a.sample_counts[U]),e>0?(i.samples[e-1].duration=a.sample_deltas[U],i.samples_duration+=i.samples[e-1].duration,z.dts=i.samples[e-1].dts+i.samples[e-1].duration):z.dts=0,o?(e>=S&&(x++,0>S&&(S=0),S+=o.sample_counts[x]),z.cts=i.samples[e].dts+o.sample_offsets[x]):z.cts=z.dts,h?e==h.sample_numbers[w]-1?(z.is_sync=!0,w++):z.is_sync=!1:z.is_sync=!0,c.process_sdtp(i.mdia.minf.stbl.sdtp,z,z.number),z.degradation_priority=u?u.priority[e]:0,d&&d.entries[0].sample_delta+B==e&&(z.subsamples=d.entries[0].subsamples,B+=d.entries[0].sample_delta),(f.length>0||l.length>0)&&c.setSampleGroupProperties(i,z,e,i.sample_groups_info)}e>0&&(i.samples[e-1].duration=Math.max(i.mdia.mdhd.duration-i.samples[e-1].dts,0),i.samples_duration+=i.samples[e-1].duration)}},c.prototype.updateSampleLists=function(){var t,e,i,s,r,n,a,o,h,p,d,f,u,m,_;if(void 0!==this.moov)for(;this.lastMoofIndex<this.moofs.length;)if(h=this.moofs[this.lastMoofIndex],this.lastMoofIndex++,"moof"==h.type)for(p=h,t=0;t<p.trafs.length;t++){for(d=p.trafs[t],f=this.getTrackById(d.tfhd.track_id),u=this.getTrexById(d.tfhd.track_id),s=d.tfhd.flags&l.TFHD_FLAG_SAMPLE_DESC?d.tfhd.default_sample_description_index:u?u.default_sample_description_index:1,r=d.tfhd.flags&l.TFHD_FLAG_SAMPLE_DUR?d.tfhd.default_sample_duration:u?u.default_sample_duration:0,n=d.tfhd.flags&l.TFHD_FLAG_SAMPLE_SIZE?d.tfhd.default_sample_size:u?u.default_sample_size:0,a=d.tfhd.flags&l.TFHD_FLAG_SAMPLE_FLAGS?d.tfhd.default_sample_flags:u?u.default_sample_flags:0,d.sample_number=0,d.sbgps.length>0&&c.initSampleGroups(f,d,d.sbgps,f.mdia.minf.stbl.sgpds,d.sgpds),e=0;e<d.truns.length;e++){var g=d.truns[e];for(i=0;i<g.sample_count;i++){(m={}).number_in_traf=d.sample_number,d.sample_number++,m.number=f.samples.length,d.first_sample_index=f.samples.length,f.samples.push(m),m.track_id=f.tkhd.track_id,m.timescale=f.mdia.mdhd.timescale,m.description_index=s-1,m.description=f.mdia.minf.stbl.stsd.entries[m.description_index],m.size=n,g.flags&l.TRUN_FLAGS_SIZE&&(m.size=g.sample_size[i]),f.samples_size+=m.size,m.duration=r,g.flags&l.TRUN_FLAGS_DURATION&&(m.duration=g.sample_duration[i]),f.samples_duration+=m.duration,f.first_traf_merged||i>0?m.dts=f.samples[f.samples.length-2].dts+f.samples[f.samples.length-2].duration:(d.tfdt?m.dts=d.tfdt.baseMediaDecodeTime:m.dts=0,f.first_traf_merged=!0),m.cts=m.dts,g.flags&l.TRUN_FLAGS_CTS_OFFSET&&(m.cts=m.dts+g.sample_composition_time_offset[i]),_=a,g.flags&l.TRUN_FLAGS_FLAGS?_=g.sample_flags[i]:0===i&&g.flags&l.TRUN_FLAGS_FIRST_FLAG&&(_=g.first_sample_flags),m.is_sync=!(_>>16&1),m.is_leading=_>>26&3,m.depends_on=_>>24&3,m.is_depended_on=_>>22&3,m.has_redundancy=_>>20&3,m.degradation_priority=65535&_,c.process_sdtp(d.sdtp,m,m.number_in_traf);var y,b=!!(d.tfhd.flags&l.TFHD_FLAG_BASE_DATA_OFFSET),v=!!(d.tfhd.flags&l.TFHD_FLAG_DEFAULT_BASE_IS_MOOF),U=!!(g.flags&l.TRUN_FLAGS_DATA_OFFSET);y=b?d.tfhd.base_data_offset:v?p.start:0===e?p.start:o,m.offset=0===e&&0===i?U?y+g.data_offset:y:o,o=m.offset+m.size,(d.sbgps.length>0||d.sgpds.length>0||f.mdia.minf.stbl.sbgps.length>0||f.mdia.minf.stbl.sgpds.length>0)&&c.setSampleGroupProperties(f,m,m.number_in_traf,d.sample_groups_info)}}if(d.subs){f.has_fragment_subsamples=!0;var S=d.first_sample_index;for(e=0;e<d.subs.entries.length;e++)S+=d.subs.entries[e].sample_delta,(m=f.samples[S-1]).subsamples=d.subs.entries[e].subsamples}}},c.prototype.getSample=function(t,e){var i,s=t.samples[e];if(!this.moov)return null;if(s.data){if(s.alreadyRead==s.size)return s}else s.data=new Uint8Array(s.size),s.alreadyRead=0,this.samplesDataSize+=s.size,a.debug("ISOFile","Allocating sample #"+e+" on track #"+t.tkhd.track_id+" of size "+s.size+" (total: "+this.samplesDataSize+")");var r=this.stream.findPosition(!0,s.offset+s.alreadyRead,!1);if(r>-1){var n=(i=this.stream.buffers[r]).byteLength-(s.offset+s.alreadyRead-i.fileStart);return s.size-s.alreadyRead<=n?(a.debug("ISOFile","Getting sample #"+e+" data (alreadyRead: "+s.alreadyRead+" offset: "+(s.offset+s.alreadyRead-i.fileStart)+" read size: "+(s.size-s.alreadyRead)+" full size: "+s.size+")"),h.memcpy(s.data.buffer,s.alreadyRead,i,s.offset+s.alreadyRead-i.fileStart,s.size-s.alreadyRead),i.usedBytes+=s.size-s.alreadyRead,this.stream.logBufferLevel(),s.alreadyRead=s.size,s):(a.debug("ISOFile","Getting sample #"+e+" partial data (alreadyRead: "+s.alreadyRead+" offset: "+(s.offset+s.alreadyRead-i.fileStart)+" read size: "+n+" full size: "+s.size+")"),h.memcpy(s.data.buffer,s.alreadyRead,i,s.offset+s.alreadyRead-i.fileStart,n),s.alreadyRead+=n,i.usedBytes+=n,this.stream.logBufferLevel(),null)}return null},c.prototype.releaseSample=function(t,e){var i=t.samples[e];return i.data?(this.samplesDataSize-=i.size,i.data=null,i.alreadyRead=0,i.size):0},c.prototype.getAllocatedSampleDataSize=function(){return this.samplesDataSize},c.prototype.getCodecs=function(){var t,e="";for(t=0;t<this.moov.traks.length;t++){t>0&&(e+=","),e+=this.moov.traks[t].mdia.minf.stbl.stsd.entries[0].getCodec()}return e},c.prototype.getTrexById=function(t){var e;if(!this.moov||!this.moov.mvex)return null;for(e=0;e<this.moov.mvex.trexs.length;e++){var i=this.moov.mvex.trexs[e];if(i.track_id==t)return i}return null},c.prototype.getTrackById=function(t){if(void 0===this.moov)return null;for(var e=0;e<this.moov.traks.length;e++){var i=this.moov.traks[e];if(i.tkhd.track_id==t)return i}return null},c.prototype.items=[],c.prototype.itemsDataSize=0,c.prototype.flattenItemInfo=function(){var t,e,i,s=this.items,r=this.meta;if(null!=r&&void 0!==r.hdlr&&void 0!==r.iinf){for(t=0;t<r.iinf.item_infos.length;t++)(i={}).id=r.iinf.item_infos[t].item_ID,s[i.id]=i,i.ref_to=[],i.name=r.iinf.item_infos[t].item_name,r.iinf.item_infos[t].protection_index>0&&(i.protection=r.ipro.protections[r.iinf.item_infos[t].protection_index-1]),r.iinf.item_infos[t].item_type?i.type=r.iinf.item_infos[t].item_type:i.type="mime",i.content_type=r.iinf.item_infos[t].content_type,i.content_encoding=r.iinf.item_infos[t].content_encoding;if(r.iloc)for(t=0;t<r.iloc.items.length;t++){var n=r.iloc.items[t];if(i=s[n.item_ID],0!==n.data_reference_index&&(a.warn("Item storage with reference to other files: not supported"),i.source=r.dinf.boxes[n.data_reference_index-1]),void 0!==n.construction_method)a.warn("Item storage with construction_method : not supported"),n.construction_method;else for(i.extents=[],i.size=0,e=0;e<n.extents.length;e++)i.extents[e]={},i.extents[e].offset=n.extents[e].extent_offset+n.base_offset,i.extents[e].length=n.extents[e].extent_length,i.extents[e].alreadyRead=0,i.size+=i.extents[e].length}if(r.pitm&&(s[r.pitm.item_id].primary=!0),r.iref)for(t=0;t<r.iref.references.length;t++){var o=r.iref.references[t];for(e=0;e<o.references.length;e++)s[o.from_item_ID].ref_to.push({type:o.type,id:o.references[e]})}}},c.prototype.getItem=function(t){var e,i;if(!this.meta)return null;if(!(i=this.items[t]).data&&i.size)i.data=new Uint8Array(i.size),i.alreadyRead=0,this.itemsDataSize+=i.size,a.debug("ISOFile","Allocating item #"+t+" of size "+i.size+" (total: "+this.itemsDataSize+")");else if(i.alreadyRead===i.size)return i;for(var s=0;s<i.extents.length;s++){var r=i.extents[s];if(r.alreadyRead!==r.length){var n=this.stream.findPosition(!0,r.offset+r.alreadyRead,!1);if(!(n>-1))return null;var o=(e=this.stream.buffers[n]).byteLength-(r.offset+r.alreadyRead-e.fileStart);if(!(r.length-r.alreadyRead<=o))return a.debug("ISOFile","Getting item #"+t+" extent #"+s+" partial data (alreadyRead: "+r.alreadyRead+" offset: "+(r.offset+r.alreadyRead-e.fileStart)+" read size: "+o+" full extent size: "+r.length+" full item size: "+i.size+")"),h.memcpy(i.data.buffer,i.alreadyRead,e,r.offset+r.alreadyRead-e.fileStart,o),r.alreadyRead+=o,i.alreadyRead+=o,e.usedBytes+=o,this.stream.logBufferLevel(),null;a.debug("ISOFile","Getting item #"+t+" extent #"+s+" data (alreadyRead: "+r.alreadyRead+" offset: "+(r.offset+r.alreadyRead-e.fileStart)+" read size: "+(r.length-r.alreadyRead)+" full extent size: "+r.length+" full item size: "+i.size+")"),h.memcpy(i.data.buffer,i.alreadyRead,e,r.offset+r.alreadyRead-e.fileStart,r.length-r.alreadyRead),e.usedBytes+=r.length-r.alreadyRead,this.stream.logBufferLevel(),r.alreadyRead=r.length,i.alreadyRead+=r.length}}return i.alreadyRead===i.size?i:null},c.prototype.releaseItem=function(t){var e=this.items[t];if(e.data){this.itemsDataSize-=e.size,e.data=null,e.alreadyRead=0;for(var i=0;i<e.extents.length;i++){e.extents[i].alreadyRead=0}return e.size}return 0},c.prototype.processItems=function(t){for(var e in this.items){var i=this.items[e];this.getItem(i.id),t&&!i.sent&&(t(i),i.sent=!0,i.data=null)}},c.prototype.hasItem=function(t){for(var e in this.items){var i=this.items[e];if(i.name===t)return i.id}return-1},c.prototype.getMetaHandler=function(){return this.meta?this.meta.hdlr.handler:null},c.prototype.getPrimaryItem=function(){return this.meta&&this.meta.pitm?this.getItem(this.meta.pitm.item_id):null},c.prototype.write=function(t){for(var e=0;e<this.boxes.length;e++)this.boxes[e].write(t)},c.writeInitializationSegment=function(t,e,i,s){var r;a.debug("ISOFile","Generating initialization segment");var n=new h;n.endianness=h.BIG_ENDIAN,t.write(n);var o=e.add("mvex");for(i&&o.add("mehd").set("fragment_duration",i),r=0;r<e.traks.length;r++)o.add("trex").set("track_id",e.traks[r].tkhd.track_id).set("default_sample_description_index",1).set("default_sample_duration",s).set("default_sample_size",0).set("default_sample_flags",65536);return e.write(n),n.buffer};var _=function(t){this.inputStream=new d,this.keepMdatData=void 0===t||t,this.inputIsoFile=new c(this.inputStream),this.inputIsoFile.discardMdatData=!this.keepMdatData,this.onMoovStart=null,this.moovStartSent=!1,this.onReady=null,this.readySent=!1,this.onSegment=null,this.onSamples=null,this.onError=null,this.sampleListBuilt=!1,this.fragmentedTracks=[],this.extractedTracks=[],this.isFragmentationInitialized=!1,this.sampleProcessingStarted=!1,this.nextMoofNumber=0,this.itemListBuilt=!1};function g(t,e,i){return e in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}_.prototype.setSegmentOptions=function(t,e,i){var s=this.inputIsoFile.getTrackById(t);if(s){var r={};this.fragmentedTracks.push(r),r.id=t,r.user=e,r.trak=s,s.nextSample=0,r.segmentStream=null,r.nb_samples=1e3,r.rapAlignement=!0,i&&(i.nbSamples&&(r.nb_samples=i.nbSamples),i.rapAlignement&&(r.rapAlignement=i.rapAlignement))}},_.prototype.unsetSegmentOptions=function(t){for(var e=-1,i=0;i<this.fragmentedTracks.length;i++){this.fragmentedTracks[i].id==t&&(e=i)}e>-1&&this.fragmentedTracks.splice(e,1)},_.prototype.setExtractionOptions=function(t,e,i){var s=this.inputIsoFile.getTrackById(t);if(s){var r={};this.extractedTracks.push(r),r.id=t,r.user=e,r.trak=s,s.nextSample=0,r.nb_samples=1e3,r.samples=[],i&&i.nbSamples&&(r.nb_samples=i.nbSamples)}},_.prototype.unsetExtractionOptions=function(t){for(var e=-1,i=0;i<this.extractedTracks.length;i++){this.extractedTracks[i].id==t&&(e=i)}e>-1&&this.extractedTracks.splice(e,1)},_.prototype.createSingleSampleMoof=function(t){var e=new l.moofBox;e.add("mfhd").set("sequence_number",this.nextMoofNumber),this.nextMoofNumber++;var i=e.add("traf");return i.add("tfhd").set("track_id",t.track_id).set("flags",l.TFHD_FLAG_DEFAULT_BASE_IS_MOOF),i.add("tfdt").set("baseMediaDecodeTime",t.dts),i.add("trun").set("flags",l.TRUN_FLAGS_DATA_OFFSET|l.TRUN_FLAGS_DURATION|l.TRUN_FLAGS_SIZE|l.TRUN_FLAGS_FLAGS|l.TRUN_FLAGS_CTS_OFFSET).set("data_offset",0).set("first_sample_flags",0).set("sample_count",1).set("sample_duration",[t.duration]).set("sample_size",[t.size]).set("sample_flags",[0]).set("sample_composition_time_offset",[t.cts-t.dts]),e},_.prototype.createFragment=function(t,e,i,s){var r=this.inputIsoFile.getTrackById(e),n=this.inputIsoFile.getSample(r,i);if(null==n)return n=r.samples[i],this.nextSeekPosition?this.nextSeekPosition=Math.min(n.offset+n.alreadyRead,this.nextSeekPosition):this.nextSeekPosition=r.samples[i].offset+n.alreadyRead,null;var o=s||new h;o.endianness=h.BIG_ENDIAN;var p=this.createSingleSampleMoof(n);p.write(o),p.trafs[0].truns[0].data_offset=p.size+8,a.debug("MP4Box","Adjusting data_offset with new value "+p.trafs[0].truns[0].data_offset),o.adjustUint32(p.trafs[0].truns[0].data_offset_position,p.trafs[0].truns[0].data_offset);var d=new l.mdatBox;return d.data=n.data,d.write(o),o},_.prototype.processSamples=function(){var t,e;if(this.sampleProcessingStarted){if(this.isFragmentationInitialized&&null!==this.onSegment)for(t=0;t<this.fragmentedTracks.length;t++){var i=this.fragmentedTracks[t];for(e=i.trak;e.nextSample<e.samples.length&&this.sampleProcessingStarted;){a.debug("MP4Box","Creating media fragment on track #"+i.id+" for sample "+e.nextSample);var s=this.createFragment(this.inputIsoFile,i.id,e.nextSample,i.segmentStream);if(!s)break;if(i.segmentStream=s,e.nextSample++,(e.nextSample%i.nb_samples==0||e.nextSample>=e.samples.length)&&(a.info("MP4Box","Sending fragmented data on track #"+i.id+" for samples ["+Math.max(0,e.nextSample-i.nb_samples)+","+(e.nextSample-1)+"]"),a.info("MP4Box","Sample data size in memory: "+this.inputIsoFile.getAllocatedSampleDataSize()),this.onSegment&&this.onSegment(i.id,i.user,i.segmentStream.buffer,e.nextSample),i.segmentStream=null,i!==this.fragmentedTracks[t]))break}}if(null!==this.onSamples)for(t=0;t<this.extractedTracks.length;t++){var r=this.extractedTracks[t];for(e=r.trak;e.nextSample<e.samples.length&&this.sampleProcessingStarted;){a.debug("MP4Box","Exporting on track #"+r.id+" sample #"+e.nextSample);var n=this.inputIsoFile.getSample(e,e.nextSample);if(!n)break;if(e.nextSample++,r.samples.push(n),(e.nextSample%r.nb_samples==0||e.nextSample>=e.samples.length)&&(a.debug("MP4Box","Sending samples on track #"+r.id+" for sample "+e.nextSample),this.onSamples&&this.onSamples(r.id,r.user,r.samples),r.samples=[],r!==this.extractedTracks[t]))break}}}},_.prototype.checkBuffer=function(t){if(null==t)throw"Buffer must be defined and non empty";if(void 0===t.fileStart)throw"Buffer must have a fileStart property";return 0===t.byteLength?(a.warn("MP4Box","Ignoring empty buffer (fileStart: "+t.fileStart+")"),this.inputStream.logBufferLevel(),!1):(a.info("MP4Box","Processing buffer (fileStart: "+t.fileStart+")"),t.usedBytes=0,this.inputStream.insertBuffer(t),this.inputStream.logBufferLevel(),!!this.inputStream.initialized()||(a.warn("MP4Box","Not ready to start parsing"),!1))},_.prototype.appendBuffer=function(t){var e;if(!this.checkBuffer||this.checkBuffer(t))return this.inputIsoFile.parse(),this.inputIsoFile.moovStartFound&&!this.moovStartSent&&(this.moovStartSent=!0,this.onMoovStart&&this.onMoovStart()),this.inputIsoFile.moov?(this.processSamples&&(this.sampleListBuilt||(this.inputIsoFile.buildSampleLists(),this.sampleListBuilt=!0),this.inputIsoFile.updateSampleLists()),this.onReady&&!this.readySent&&(this.readySent=!0,this.onReady(this.getInfo())),this.processSamples&&this.processSamples(),this.nextSeekPosition?(e=this.nextSeekPosition,this.nextSeekPosition=void 0):e=this.inputIsoFile.nextParsePosition,this.inputStream.getEndFilePositionAfter&&(e=this.inputStream.getEndFilePositionAfter(e))):e=null!==this.inputIsoFile?this.inputIsoFile.nextParsePosition:0,this.inputIsoFile.meta&&(this.inputIsoFile.flattenItemInfo&&!this.itemListBuilt&&(this.inputIsoFile.flattenItemInfo(),this.itemListBuilt=!0),this.inputIsoFile.processItems&&this.inputIsoFile.processItems(this.onItem)),this.inputStream.cleanBuffers&&(a.info("MP4Box","Done processing buffer (fileStart: "+t.fileStart+") - next buffer to fetch should have a fileStart position of "+e),this.inputStream.logBufferLevel(),this.inputStream.cleanBuffers(),this.inputStream.logBufferLevel(!0),a.info("MP4Box","Sample data size in memory: "+this.inputIsoFile.getAllocatedSampleDataSize())),e},_.prototype.getInfo=function(){var t,e,i,s,r,n={},a=new Date(4,0,1,0,0,0,0).getTime();if(this.inputIsoFile.moov)for(n.hasMoov=!0,n.duration=this.inputIsoFile.moov.mvhd.duration,n.timescale=this.inputIsoFile.moov.mvhd.timescale,n.isFragmented=null!=this.inputIsoFile.moov.mvex,n.isFragmented&&this.inputIsoFile.moov.mvex.mehd&&(n.fragment_duration=this.inputIsoFile.moov.mvex.mehd.fragment_duration),n.isProgressive=this.inputIsoFile.isProgressive,n.hasIOD=null!=this.inputIsoFile.moov.iods,n.brands=[],n.brands.push(this.inputIsoFile.ftyp.major_brand),n.brands=n.brands.concat(this.inputIsoFile.ftyp.compatible_brands),n.created=new Date(a+1e3*this.inputIsoFile.moov.mvhd.creation_time),n.modified=new Date(a+1e3*this.inputIsoFile.moov.mvhd.modification_time),n.tracks=[],n.audioTracks=[],n.videoTracks=[],n.subtitleTracks=[],n.metadataTracks=[],n.hintTracks=[],n.otherTracks=[],t=0;t<this.inputIsoFile.moov.traks.length;t++){if(r=(i=this.inputIsoFile.moov.traks[t]).mdia.minf.stbl.stsd.entries[0],s={},n.tracks.push(s),s.id=i.tkhd.track_id,s.name=i.mdia.hdlr.name,s.references=[],i.tref)for(e=0;e<i.tref.boxes.length;e++)ref={},s.references.push(ref),ref.type=i.tref.boxes[e].type,ref.track_ids=i.tref.boxes[e].track_ids;i.edts&&(s.edits=i.edts.elst.entries),s.created=new Date(a+1e3*i.tkhd.creation_time),s.modified=new Date(a+1e3*i.tkhd.modification_time),s.movie_duration=i.tkhd.duration,s.movie_timescale=n.timescale,s.layer=i.tkhd.layer,s.alternate_group=i.tkhd.alternate_group,s.volume=i.tkhd.volume,s.matrix=i.tkhd.matrix,s.track_width=i.tkhd.width/65536,s.track_height=i.tkhd.height/65536,s.timescale=i.mdia.mdhd.timescale,s.cts_shift=i.mdia.minf.stbl.cslg,s.duration=i.mdia.mdhd.duration,s.samples_duration=i.samples_duration,s.codec=r.getCodec(),s.kind=i.udta&&i.udta.kinds.length?i.udta.kinds[0]:{schemeURI:"",value:""},s.language=i.mdia.elng?i.mdia.elng.extended_language:i.mdia.mdhd.languageString,s.nb_samples=i.samples.length,s.size=i.samples_size,s.bitrate=8*s.size*s.timescale/s.samples_duration,r.isAudio()?(s.type="audio",n.audioTracks.push(s),s.audio={},s.audio.sample_rate=r.getSampleRate(),s.audio.channel_count=r.getChannelCount(),s.audio.sample_size=r.getSampleSize()):r.isVideo()?(s.type="video",n.videoTracks.push(s),s.video={},s.video.width=r.getWidth(),s.video.height=r.getHeight()):r.isSubtitle()?(s.type="subtitles",n.subtitleTracks.push(s)):r.isHint()?(s.type="metadata",n.hintTracks.push(s)):r.isMetadata()?(s.type="metadata",n.metadataTracks.push(s)):(s.type="metadata",n.otherTracks.push(s))}else n.hasMoov=!1;for(n.mime="",n.videoTracks.length>0?n.mime+='video/mp4; codecs="':n.audioTracks.length>0?n.mime+='audio/mp4; codecs="':n.mime+='application/mp4; codecs="',t=0;t<n.tracks.length;t++)0!==t&&(n.mime+=","),n.mime+=n.tracks[t].codec;return n.mime+='"; profiles="',n.mime+=this.inputIsoFile.ftyp.compatible_brands.join(),n.mime+='"',n},_.prototype.writeFile=function(){var t=new h;return t.endianness=h.BIG_ENDIAN,this.inputIsoFile.write(t),t.buffer},_.prototype.initializeSegmentation=function(){var t,e,i,s;for(null===this.onSegment&&a.warn("MP4Box","No segmentation callback set!"),this.isFragmentationInitialized||(this.isFragmentationInitialized=!0,this.nextMoofNumber=0,this.inputIsoFile.resetTables()),e=[],t=0;t<this.fragmentedTracks.length;t++){var r=new l.moovBox;r.mvhd=this.inputIsoFile.moov.mvhd,r.boxes.push(r.mvhd),i=this.inputIsoFile.getTrackById(this.fragmentedTracks[t].id),r.boxes.push(i),r.traks.push(i),(s={}).id=i.tkhd.track_id,s.user=this.fragmentedTracks[t].user,s.buffer=c.writeInitializationSegment(this.inputIsoFile.ftyp,r,this.inputIsoFile.moov.mvex&&this.inputIsoFile.moov.mvex.mehd?this.inputIsoFile.moov.mvex.mehd.fragment_duration:void 0,this.inputIsoFile.moov.traks[t].samples.length>0?this.inputIsoFile.moov.traks[t].samples[0].duration:0),e.push(s)}return e},_.prototype.releaseUsedSamples=function(t,e){var i=0,s=this.inputIsoFile.getTrackById(t);s.lastValidSample||(s.lastValidSample=0);for(var r=s.lastValidSample;e>r;r++)i+=this.inputIsoFile.releaseSample(s,r);a.info("MP4Box","Track #"+t+" released samples up to "+e+" (released size: "+i+", remaining: "+this.inputIsoFile.samplesDataSize+")"),s.lastValidSample=e},_.prototype.flush=function(){a.info("MP4Box","Flushing remaining samples"),this.inputIsoFile.updateSampleLists(),this.processSamples(),this.inputStream.cleanBuffers(),this.inputStream.logBufferLevel(!0)},_.prototype.seekTrack=function(t,e,i){var s,r,n,o,h=0,p=0;if(0===i.samples.length)return a.info("MP4Box","No sample in track, cannot seek! Using time "+a.getDurationString(0,1)+" and offset: 0"),{offset:0,time:0};for(s=0;s<i.samples.length;s++){if(r=i.samples[s],0===s)p=0,n=r.timescale;else if(r.cts>t*r.timescale){p=s-1;break}e&&r.is_sync&&(h=s)}for(e&&(p=h),t=i.samples[p].cts,i.nextSample=p;i.samples[p].alreadyRead===i.samples[p].size;)p++;return o=i.samples[p].offset+i.samples[p].alreadyRead,a.info("MP4Box","Seeking to "+(e?"RAP":"")+" sample #"+i.nextSample+" on track "+i.tkhd.track_id+", time "+a.getDurationString(t,n)+" and offset: "+o),{offset:o,time:t/n}},_.prototype.seek=function(t,e){var i,s,r,n=this.inputIsoFile.moov,o={offset:1/0,time:1/0};if(this.inputIsoFile.moov){for(r=0;r<n.traks.length;r++)i=n.traks[r],(s=this.seekTrack(t,e,i)).offset<o.offset&&(o.offset=s.offset),s.time<o.time&&(o.time=s.time);return a.info("MP4Box","Seeking at time "+a.getDurationString(o.time,1)+" needs a buffer with a fileStart position of "+o.offset),o.offset===1/0?o={offset:this.inputIsoFile.nextParsePosition,time:0}:o.offset=this.inputStream.getEndFilePositionAfter(o.offset),a.info("MP4Box","Adjusted seek position (after checking data already in buffer): "+o.offset),o}throw"Cannot seek: moov not received!"},_.prototype.getTrackSamplesInfo=function(t){var e=this.inputIsoFile.getTrackById(t);return e?e.samples:void 0},_.prototype.getTrackSample=function(t,e){var i=this.inputIsoFile.getTrackById(t);return this.inputIsoFile.getSample(i,e)},_.prototype.start=function(){this.sampleProcessingStarted=!0,this.processSamples()},_.prototype.stop=function(){this.sampleProcessingStarted=!1},"undefined"!=typeof exports&&(exports.MP4Box=_),i.d(e,"VideoStreamingProcess",(function(){return v}));const y=262144,b=1048576;class v{constructor(t,e){g(this,"onSourceBufferUpdateEnd",t=>{const e=t.target,i=e.pendingSegments.shift();i&&this.appendSegmentBuffer(e,i)}),g(this,"onTimeUpdate",()=>{this.resumeLoader&&this.checkLowBuffer()&&this.resumeLoader()}),this.doc=t,this.onProgress=e,this.mediaSource=new MediaSource,this.video=document.createElement("video"),this.video.src=URL.createObjectURL(this.mediaSource),this.video.addEventListener("timeupdate",this.onTimeUpdate)}load(){return this.mp4box=new _(!1),this.mp4box.onReady=t=>{t.isFragmented?this.mediaSource.duration=t.fragment_duration/t.timescale:this.mediaSource.duration=t.duration/t.timescale,this.mp4box.onSegment=(t,e,i)=>{this.appendSegmentBuffer(e,i)},this.addSourceBuffers(t),this.mp4box.start()},this.mp4box.onError=t=>{console.log("Received Error Message",t)},window.mp4box=this.mp4box,this.loadPart(0),new Promise((t,e)=>{this.video.addEventListener("loadeddata",e=>{this.loadeddata=!0,t(e.target)}),this.video.addEventListener("error",t=>{e(t.target.error)})})}async loadPart(t){const e=t<3072?y:b,i=(await n.a.loadDocumentBytes(this.doc,t,e)).buffer;i.fileStart=t;let s=this.mp4box.appendBuffer(i);!s&&this.gapStart&&(s=this.gapStart,this.gapStart=null),s?this.checkLowBuffer()?this.loadPart(s):this.resumeLoader=()=>{this.loadPart(s),this.resumeLoader=null}:(this.mp4box.flush(),this.mediaSource.endOfStream()),this.loadeddata||(this.loadedBytes=(this.loadedBytes||0)+i.byteLength,this.onProgress&&this.onProgress(this.loadedBytes))}addSourceBuffers(t){for(const e of t.tracks){const t=`video/mp4; codecs="${e.codec}"`,i=this.mediaSource.addSourceBuffer(t);i.pendingSegments=[],i.addEventListener("updateend",this.onSourceBufferUpdateEnd),this.mp4box.setSegmentOptions(e.id,i,{nbSamples:100})}for(const{user:t,buffer:e}of this.mp4box.initializeSegmentation())this.appendSegmentBuffer(t,e)}appendSegmentBuffer(t,e){t.updating?t.pendingSegments.push(e):t.appendBuffer(e)}stop(){try{this.mp4box.stop(),URL.revokeObjectURL(this.video.src)}catch(t){console.error(t)}}checkLowBuffer(){const t=this.video,e=t.buffered;return!e.length||e.end(0)<t.currentTime+180}}}}]);