(window.webpackJsonp=window.webpackJsonp||[]).push([[4],{26:function(e,t,s){"use strict";s.r(t),s.d(t,"AudioPlayer",(function(){return c}));var i=s(0),a=s(21);function o(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}window.audioStreamingResources=new WeakSet;class r{constructor(e){o(this,"bufferQueue",[]),o(this,"ended",!1),o(this,"stopped",!1),o(this,"onUpdateEnd",()=>{const e=this.bufferQueue.shift();e?this.appendBuffer(e):this.ended&&this.mediaSource.endOfStream()}),o(this,"onTimeUpdate",()=>{this.resumeLoader&&this.checkLowBuffer()&&this.resumeLoader()}),this.doc=e;const t=new MediaSource;t.addEventListener("sourceopen",()=>{this.stopped||(this.sourceBuffer=t.addSourceBuffer("audio/mpeg"),this.sourceBuffer.addEventListener("updateend",this.onUpdateEnd))}),this.mediaSource=t;const s=document.createElement("audio");s.addEventListener("timeupdate",this.onTimeUpdate),s.src=URL.createObjectURL(this.mediaSource),this.audio=s,this.load()}load(){const e=new n({onSegmentReady:e=>{this.appendBuffer(e)},onDurationChange:e=>{this.mediaSource.duration=e}}),t=async(s,i)=>{if(this.stopped)return;if(s>=this.doc.size)return void this.endStream();const o=i<5?262144:1048576,r=await a.a.loadDocumentBytes(this.doc,s,o);e.append(r);const n=s+r.length;this.checkLowBuffer()?t(n,i+1):this.resumeLoader=()=>{t(n,i+1),this.resumeLoader=null}};t(0,0)}checkLowBuffer(){const e=this.audio,t=e.buffered;return!t.length||t.end(0)<e.currentTime+180}appendBuffer(e){if(!this.stopped)if(this.sourceBuffer.updating)this.bufferQueue.push(e);else try{this.sourceBuffer.appendBuffer(e)}catch(t){if("QuotaExceededError"!==t.name)throw t;this.bufferQueue.unshift(e);const s=this.audio.buffered.start(0);this.sourceBuffer.remove(s,s+30)}}endStream(){this.ended=!0,this.sourceBuffer.updating||this.bufferQueue.length||this.mediaSource.endOfStream()}stop(){this.stopped=!0,URL.revokeObjectURL(this.audio.src),this.audio.src="",this.audio.load()}}class n{constructor({onSegmentReady:e,onDurationChange:t}){o(this,"ID3_HEADER_SIZE",10),o(this,"FRAME_HEADER_SIZE",4),o(this,"XING_HEADER_OFFSET",32),o(this,"haveMeta",!1),this.onSegmentReady=e,this.onDurationChange=t}append(e){if(this.prevBytes){const t=this.prevBytes,s=e;(e=new Uint8Array(t.length+s.length)).set(t),e.set(s,t.length),this.prevBytes=null}let t=0;for(;t<e.length;){const s=this.parseFrame(e,t);if(!s)break;t=s}if(this.prevBytes=e.slice(t),t){const s=e.slice(0,t);this.onSegmentReady(s)}}parseFrame(e,t){let s=t;const i=!this.haveMeta;if(i){if(s=this.ID3_HEADER_SIZE+this.getID3Size(e.subarray(6,10)),e.length<s)return 0;this.haveMeta=!0}if(e.length-s<4)return 0;const a=e.subarray(s,s+this.FRAME_HEADER_SIZE);if(255!=(255&a[0])&&15!=(15&a[1]))return console.log("end of mp3"),0;const o=(24&a[1])>>>3,r=(6&a[1])>>>1,n=(240&a[2])>>>4,u=(12&a[2])>>>2,c=(2&a[2])>>>1,h=d.bitrate[o][r][n],l=d.samplerate[o][u],m=Math.floor(1e3*h/l*144)+(c?d.slot[r]:0);if(i){const t=s+this.FRAME_HEADER_SIZE+this.XING_HEADER_OFFSET,i=e.slice(t,t+16),a=(new TextDecoder).decode(i.slice(0,4));if("Info"===a||"Xing"===a){const e=new DataView(i.buffer);if(1&e.getInt32(4)){const t=e.getInt32(8)*d.samplePerFrame[o][r]/l;this.onDurationChange&&this.onDurationChange(t)}}}return e.length-s<m?0:s+m}getID3Size(e){return(127&e[0])<<21|(127&e[1])<<14|(127&e[2])<<7|127&e[3]}}const d={frame:{0:"MPEG 2.5",1:"Reserved",2:"MPEG 2",3:"MPEG 1"},layer:{0:"reserved",1:"Layer III",2:"Layer II",3:"Layer I"},bitrate:{3:{1:[0,32,40,48,56,64,80,96,112,128,160,192,224,256,320,-1],2:[0,32,48,56,64,80,96,112,128,160,192,224,256,320,384,-1],3:[0,32,64,96,128,160,192,224,256,288,320,352,384,416,488,-1]},2:{3:[0,32,48,56,64,80,96,112,128,144,160,176,192,224,256,-1],2:[0,8,16,24,32,40,48,56,64,80,96,112,128,144,160,-1],1:[0,8,16,24,32,40,48,56,64,80,96,112,128,144,160,-1]},0:{3:[0,32,48,56,64,80,96,112,128,144,160,176,192,224,256,-1],2:[0,8,16,24,32,40,48,56,64,80,96,112,128,144,160,-1],1:[0,8,16,24,32,40,48,56,64,80,96,112,128,144,160,-1]}},samplerate:{3:[44100,48e3,32e3,-1],2:[22050,24e3,16e3,-1],0:[11025,12e3,8e3]},channel:["Stereo","Joint Stereo","Dual Channel","Single Channel"],slot:{3:4,2:1,1:1},samplePerFrame:{3:{3:384,2:1152,1:1152},2:{3:384,2:1152,1:576},0:{3:384,2:1152,1:576}}};var u=s(1);class c{constructor(e,t){var s,i,a;a=[],(i="listeners")in(s=this)?Object.defineProperty(s,i,{value:a,enumerable:!0,configurable:!0,writable:!0}):s[i]=a,this.doc=e,this.attributes=t}initStreaming(){this.streamingProcess=new r(this.doc),this.audio=this.streamingProcess.audio}initSrc(e){const t=document.createElement("audio");"audio/ogg"!==this.doc.mime_type||t.canPlayType("audio/ogg")?(this.audio=t,t.src=e):this.audioPromise=this.initOGVPlayer(this.doc,e)}async initOGVPlayer(e,t){window.OGVPlayer||await Object(i.K)("./vendor/ogvjs/ogv.js");const{OGVPlayer:s,OGVLoader:a}=window;a.base="vendor/ogvjs";const o=new s;return o.type=this.doc.mime_type,o.src=t,console.log("playing audio with ogv.js",o,this.doc),this.audio=o,o}async listen(e,t){if("stop"!==e){(await this.getAudio()).addEventListener(e,t)}this.listeners.push([e,t])}getAudio(){return this.audio?Promise.resolve(this.audio):this.audioPromise}async play(){(await this.getAudio()).play()}async pause(){(await this.getAudio()).pause()}isPaused(){return!!this.audio&&this.audio.paused}async togglePlay(){const e=await this.getAudio();e.paused?e.play():e.pause()}getDuration(){const e=this.audio;return e&&isFinite(e.duration)?e.duration:this.attributes.duration}getCurrentTime(){return this.audio?this.audio.currentTime:0}async seek(e){(await this.getAudio()).currentTime=e}async destroy(){const e=await this.getAudio();if(e){e.pause();for(const[t,s]of this.listeners)if("stop"===t)try{s()}catch(e){console.error(e)}else e.removeEventListener(t,s);this.audio=null,this.streamingProcess&&(this.streamingProcess.stop(),this.streamingProcess=null),this.listeners=[]}}initMessageAudioPlayer(e){this.listen("play",t=>{e.classList.add("document_icon-playing"),r(t.target)}),this.listen("pause",()=>{e.classList.remove("document_icon-playing"),n()}),this.listen("timeupdate",e=>{const t=e.target;o(t.currentTime,this.getDuration())}),this.listen("ended",()=>{a(0),o(0,this.getDuration())}),this.listen("stop",()=>{s.innerText=Object(i.v)(this.getDuration()),e.classList.remove("document_icon-playing"),n(),a(0)});const t=e.closest(".document"),s=Object(i.a)(".document_duration",t);let a,o;if("voice"===this.attributes.type){const e=Object(i.a)(".document_voice_wave-filled",t);a=t=>{e&&(e.style.width=100*t+"%")},o=(e,t)=>{s.innerText=Object(i.v)(t-e)}}else this.initAudioProgressBar(t),a=e=>{},o=(e,t)=>{s.innerText=`${Object(i.v)(e)} / ${Object(i.v)(t)}`};const[r,n]=Object(i.E)(e=>{a(e.currentTime/this.getDuration())});e.classList.toggle("document_icon-playing",!this.isPaused()),o(this.getCurrentTime(),this.getDuration()),a(this.getCurrentTime()/this.getDuration())}initAudioProgressBar(e){const t=i.e.html`
      <div class="document_progressbar">
        <div class="document_progressbar_loaded"></div>
        <div class="document_progressbar_played"></div>
      </div>
    `.buildElement();Object(i.a)(".document_filename",e).after(t);const s=t.firstElementChild,a=t.lastElementChild;let o=!1;t.addEventListener("mousedown",e=>{let s;e.preventDefault(),o=!0,t.classList.add("document_progressbar-dragging");const r=e=>{const{pageX:o}=Object(i.A)(e),r=t.getBoundingClientRect();s=Math.max(0,Math.min(1,(o-r.x)/r.width)),a.style.setProperty("--progress-value",s)},n=e=>{window.document.removeEventListener("mousemove",r),window.document.removeEventListener("mouseup",n),this.seek(s*this.getDuration()),o=!1,t.classList.remove("document_progressbar-dragging")};window.document.addEventListener("mousemove",r),window.document.addEventListener("mouseup",n),r(e)});const r=e=>{const t=this.getDuration(),i=e.buffered;if(i.length){const e=Math.max(0,Math.min(1,i.end(i.length-1)/t));s.style.setProperty("--progress-value",e)}},n=()=>{if(!o){const e=Math.max(0,Math.min(1,this.getCurrentTime()/this.getDuration()));a.style.setProperty("--progress-value",e)}};this.listen("progress",e=>r(e.target)),this.listen("timeupdate",()=>n()),this.listen("stop",()=>{t.remove()}),this.audio&&(r(this.audio),n())}initHeaderAudioPlayer(e){const t=Object(i.a)(".messages_header_audio_wrap",this.header);let s,a;if(t.innerHTML="","voice"===this.attributes.type){const t=u.a.getPeerName(u.a.getMessageAuthorPeer(e),!1);s=i.e.html`
        <div class="messages_header_audio mdc-ripple-surface">
          <div class="messages_header_audio_voice_author">${t}</div>
          <div class="messages_header_audio_voice_type">Voice Message</div>
          <div class="mdc-icon-button messages_header_audio_close_button"></div>
        </div>
      `.buildElement(),a=Object(i.a)(".messages_header_audio_voice_author",s)}else{const e=this.attributes,t=e.audio_title||e.file_name||"Unknown Track",o=e.audio_performer;s=i.e.html`
        <div class="messages_header_audio mdc-ripple-surface">
          <div class="messages_header_audio_title">${t}</div>
          <div class="messages_header_audio_performer">${o}</div>
          <div class="mdc-icon-button messages_header_audio_close_button"></div>
        </div>
      `.buildElement(),a=Object(i.a)(".messages_header_audio_title",s)}const o=Object(i.a)(".messages_header_audio_close_button",s);return Object(i.g)(s),t.appendChild(s),this.listen("play",()=>{s.classList.add("messages_header_audio-playing")}),this.listen("pause",()=>{s.classList.remove("messages_header_audio-playing")}),this.listen("stop",()=>{s.remove()}),s.addEventListener("click",()=>{this.togglePlay()}),a.addEventListener("click",t=>{t.stopPropagation();const s=u.a.getMessageDialogPeerId(e);MessagesController.setChatByPeerId(s,e.id)}),o.addEventListener("click",e=>{e.stopPropagation(),this.destroy()}),s}}}}]);