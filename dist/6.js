(window.webpackJsonp=window.webpackJsonp||[]).push([[6],{32:function(t,e,s){"use strict";s.r(e);var o=s(0),i=s(1),l=s(11),n=s(8),r=s(4);s(37);function a(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}const c=new class{constructor(){a(this,"renderOptions",(t,e,s)=>{const l=document.createDocumentFragment();for(let r=0;r<t.length;r++){const{count:a,users:c,votes:d,next_offset:p}=t[r];i.a.updateUsers(c);const h=o.e.html`
        <div class="poll_results_option" data-index="${r}">
          <div class="poll_results_option_header _cut_text">
            <div class="poll_results_option_title _cut_text">${e.answers[r].text}</div>
            <div class="poll_results_option_percent">${s.total_voters?Math.round(a/s.total_voters*100):0}%</div>
          </div>
          <div class="poll_results_option_voters"></div>
          <div class="poll_results_option_show_more mdc-ripple-surface" data-index="${r}" hidden></div>
        </div>
      `.buildElement();if(this.renderVoters(Object(o.a)(".poll_results_option_voters",h),d),d.length<a){const t=Object(o.a)(".poll_results_option_show_more",h);t.innerText=n.a.getPlural("poll_n_more_voters",a-d.length),t.hidden=!1,t.dataset.nextOffset=p,t.addEventListener("click",this.onMoreClick),Object(o.g)(t)}l.appendChild(h)}Object(o.a)(".poll_results_options_list",this.container).appendChild(l)}),a(this,"onMoreClick",t=>{const e=t.currentTarget,s=e.dataset.index,o=e.dataset.nextOffset,l=this.pollController.poll.answers[s].option;this.pollController.loadVotes(l,50,o).then(({count:t,votes:s,users:o,next_offset:l})=>{i.a.updateUsers(o);const r=e.previousElementSibling;this.renderVoters(r,s),t>r.childElementCount?(e.innerText=n.a.getPlural("poll_n_more_voters",t-r.childElementCount),e.dataset.nextOffset=l):e.hidden=!0})}),a(this,"onBack",()=>{this.hide()})}show(t){this.container=Object(o.a)(".right_sidebar"),this.container.hidden=!1,r.a.onRightSidebarOpen(),this.container.innerHTML=o.e.html`
      <div class="sidebar_header">
        <button type="button" class="sidebar_close_button mdc-icon-button"></button>
        <div class="sidebar_header_title">Results</div>
      </div>
      <div class="poll_results_sidebar">
        <div class="poll_results_header">${t.poll.question}</div>
        <div class="poll_results_options_list"></div>
      </div>
    `,Object(o.a)(".sidebar_close_button",this.container).addEventListener("click",this.onBack),this.pollController=t;const e=Object(o.i)(this.container);t.loadAllVotes().then(e=>{this.renderOptions(e,t.poll,t.results)}).finally(()=>e.remove())}renderVoters(t,e){const s=document.createDocumentFragment();for(const t of e){const e=i.a.users.get(t.user_id),n=o.e.html`
        <div class="poll_results_option_votes_item">
          <div class="poll_results_option_votes_item_photo"></div>
          <div class="poll_results_option_votes_item_name _cut_text">${i.a.getUserName(e)}</div>
        </div>
      `.buildElement();s.appendChild(n),l.a.loadPeerPhoto(Object(o.a)(".poll_results_option_votes_item_photo",n),i.a.getUserPeer(e))}t.appendChild(s)}hide(){this.container.hidden=!0,r.a.onRightSidebarClose()}};var d=s(3);function p(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}s.d(e,"PollController",(function(){return h}));class h{constructor(t,e){p(this,"onOptionClick",t=>{if(this.isVotedPoll())return;if(t.currentTarget.classList.toggle("poll_option-selected"),this.poll.multiple_choice){const t=!!Object(o.a)(".poll_option-selected",this.container);this.submitButton.disabled=!t}else this.submit()}),p(this,"onPollUpdate",t=>{const e=t.detail;e.poll_id===this.poll.id&&this.updateResults(e.results)}),this.container=Object(o.a)(".poll",t),this.message=e,this.poll=e.media.poll,this.results=e.media.results;for(const t of Object(o.b)(".poll_option",this.container))t.addEventListener("click",this.onOptionClick);this.poll.multiple_choice&&(this.submitButton=Object(o.a)(".poll_vote_button",this.container),this.submitButton.addEventListener("click",()=>this.submit())),this.poll.public_voters&&(this.resultsButton=Object(o.a)(".poll_results_button",this.container),this.resultsButton.addEventListener("click",()=>this.showResults())),this.poll.quiz&&(this.solutionButton=Object(o.a)(".poll_quiz_solution_button",this.container),this.solutionButton.addEventListener("click",()=>this.showSolution())),(this.poll.close_date||this.poll.close_period)&&this.initQuizTimer(),this.results.recent_voters&&this.showRecentVoters(),i.a.emitter.on("messagePollUpdate",this.onPollUpdate)}showRecentVoters(){const t=document.createDocumentFragment();for(const e of this.results.recent_voters){const s=o.e.html`<div class="poll_recent_voters_item"></div>`.buildElement();t.appendChild(s),l.a.loadPeerPhoto(s,i.a.getPeerById(e))}Object(o.a)(".poll_recent_voters",this.container).appendChild(t)}async submit(){const t=Array.from(Object(o.b)(".poll_option-selected",this.container)).map(t=>this.poll.answers[t.dataset.index].option);if(await this.sendVote(t),this.poll.quiz){Object(o.a)(".poll_option-selected",this.container).classList.contains("poll_option-correct")?this.confetti():(this.wiggle(),this.results.solution&&this.showSolution())}}isVotedPoll(){return this.container.classList.contains("poll-voted")}wiggle(){this.container.closest(".message").classList.add("message-wiggle")}confetti(){}initQuizTimer(){const t=this.poll;let e,s;console.log("poll with timer",t),t.close_date?(e=1e3*(t.close_date-d.a.getServerTimeOffset()),s=e-Date.now()):(s=1e3*t.close_period,e=Date.now()+s);const i=o.e.html`<span class="poll_quiz_timer_text"></span>`.buildElement(),l=o.e.html`
      <svg class="poll_quiz_timer_svg" viewBox="8 8 16 16" xmlns="http://www.w3.org/2000/svg">
        <circle class="poll_quiz_timer_circle" cx="16" cy="16" r="7" transform="matrix(0 -1 -1 0 32 32)"/>
      </svg>
    `.buildElement(),n=Object(o.a)(".poll_quiz_timer",this.container);let r;n.append(i,l);const[a,c]=Object(o.B)(()=>{const t=Date.now();if(t>=e)this.stopTimer&&(this.stopTimer(),this.container.classList.add("poll-voted"));else{const n=Math.max(0,e-t),a=Math.floor(n/1e3);a!==r&&(r=a,i.innerText=Object(o.u)(a)),l.firstElementChild.style.setProperty("--progress-value",n/s)}});this.stopTimer=()=>{c(),n.innerHTML="",this.stopTimer=null},a()}showSolution(){const t=this.results,e=MessagesController.processTextEntities(t.solution,t.solution_entities),s=o.e.html`<div class="poll_solution_bubble" hidden>${e}</div>`.buildElement();let i;Object(o.a)(".messages_container").appendChild(s),requestAnimationFrame(()=>s.hidden=!1);const l=t=>{i=setTimeout(()=>{s.hidden=!0,setTimeout(()=>s.remove(),200)},t)};s.addEventListener("mouseenter",()=>clearTimeout(i)),s.addEventListener("mouseleave",()=>l(500)),l(3e3)}async sendVote(t){const e=i.a.getMessageDialogPeer(this.message),s=await d.a.callMethod("messages.sendVote",{peer:i.a.getInputPeer(e),msg_id:this.message.id,options:t});i.a.onUpdates(s)}showResults(){c.show(this)}loadAllVotes(){const t=this.poll.answers.map(t=>this.loadVotes(t.option,4));return Promise.all(t)}loadVotes(t,e,s=""){const o=i.a.getMessageDialogPeer(this.message),l=i.a.getInputPeer(o);return d.a.callMethod("messages.getPollVotes",{peer:l,id:this.message.id,option:t,limit:e,offset:s})}updateResults(t){this.results=t;const e=this.poll,s=t.total_voters;let i=!1;if(t.results)for(const l of Object(o.b)(".poll_option",this.container)){const n=l.dataset.index,r=t.results[n],a=s?Math.round(r.voters/s*100):0,c=Object(o.a)(".poll_option_percent",l);c.innerText=a+"%",c.classList.toggle("poll_option_percent-long",100===a),Object(o.a)(".poll_option_scale",l).style.setProperty("--voters-percent",a+"%"),l.classList.toggle("poll_option-selected",!!r.chosen),e.quiz&&(l.classList.toggle("poll_option-correct",!!r.correct),l.classList.toggle("poll_option-wrong",!r.correct)),r.chosen&&(i=!0)}this.container.classList.toggle("poll-voted",i),e.quiz&&(this.solutionButton.hidden=!t.solution),i&&this.stopTimer&&this.stopTimer(),Object(o.a)(".poll_voters",this.container).innerText=MessagesController.formatPollFooterText(e,s)}destroy(){i.a.emitter.off("messagePollUpdate",this.onPollUpdate)}}},37:function(t,e,s){}}]);